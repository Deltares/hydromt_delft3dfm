
<!DOCTYPE html>


<html lang="en" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hydromt_delft3dfm.dflowfm &#8212; HydroMT Delft3D FM  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme-deltares.css?v=17060807" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script src="../../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/hydromt_delft3dfm/dflowfm';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
    
    <img src="../../_static/hydromt-logo.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/hydromt-logo.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
    <p class="title logo__title">HydroMT Delft3D FM</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../getting_started/intro.html">
                        Getting started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../user_guide/intro.html">
                        User guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../dev_guide/intro.html">
                        Developments
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://deltares.github.io/hydromt/latest/index.html">
                    HydroMT core
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares/hydromt_delft3dfm" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg" class="icon-link-image" alt="GitHub"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="for https://oss.deltares.nl/web/delft3dfm" title="Delft3D FM Suite" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/logo_delft3dfm.png" class="icon-link-image" alt="Delft3D FM Suite"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.deltares.nl/en/" title="Deltares" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../getting_started/intro.html">
                        Getting started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../user_guide/intro.html">
                        User guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../dev_guide/intro.html">
                        Developments
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://deltares.github.io/hydromt/latest/index.html">
                    HydroMT core
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Deltares/hydromt_delft3dfm" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg" class="icon-link-image" alt="GitHub"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="for https://oss.deltares.nl/web/delft3dfm" title="Delft3D FM Suite" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/logo_delft3dfm.png" class="icon-link-image" alt="Delft3D FM Suite"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.deltares.nl/en/" title="Deltares" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/deltares-blue.svg" class="icon-link-image" alt="Deltares"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">hydromt_delf...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for hydromt_delft3dfm.dflowfm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implement Delft3D-FM hydromt plugin model class.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">hydromt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">xugrid</span> <span class="k">as</span> <span class="nn">xu</span>
<span class="kn">from</span> <span class="nn">hydrolib.core.dflowfm</span> <span class="kn">import</span> <span class="n">FMModel</span><span class="p">,</span> <span class="n">IniFieldModel</span>
<span class="kn">from</span> <span class="nn">hydrolib.core.dimr</span> <span class="kn">import</span> <span class="n">DIMR</span><span class="p">,</span> <span class="n">FMComponent</span><span class="p">,</span> <span class="n">Start</span>
<span class="kn">from</span> <span class="nn">hydromt.models</span> <span class="kn">import</span> <span class="n">MeshModel</span>
<span class="kn">from</span> <span class="nn">hydromt.workflows</span> <span class="kn">import</span> <span class="n">create_mesh2d</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">DATADIR</span><span class="p">,</span> <span class="n">gis_utils</span><span class="p">,</span> <span class="n">mesh_utils</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">workflows</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DFlowFMModel&quot;</span><span class="p">]</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="DFlowFMModel">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.html#hydromt_delft3dfm.DFlowFMModel">[docs]</a>
<span class="k">class</span> <span class="nc">DFlowFMModel</span><span class="p">(</span><span class="n">MeshModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API for Delft3D-FM models in HydroMT.&quot;&quot;&quot;</span>

    <span class="n">_NAME</span> <span class="o">=</span> <span class="s2">&quot;dflowfm&quot;</span>
    <span class="n">_CONF</span> <span class="o">=</span> <span class="s2">&quot;DFlowFM.mdu&quot;</span>
    <span class="n">_DATADIR</span> <span class="o">=</span> <span class="n">DATADIR</span>
    <span class="n">_GEOMS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_API</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">CRS</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="s2">&quot;geoms&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">],</span>
        <span class="s2">&quot;maps&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]],</span>
        <span class="s2">&quot;mesh&quot;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">xu</span><span class="o">.</span><span class="n">UgridDataArray</span><span class="p">,</span> <span class="n">xu</span><span class="o">.</span><span class="n">UgridDataset</span><span class="p">],</span>
        <span class="s2">&quot;forcing&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]],</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]],</span>
        <span class="s2">&quot;states&quot;</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]],</span>
    <span class="p">}</span>
    <span class="n">_MAPS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;elevtn&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bedlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;waterlevel&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;waterlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;averagingrelsize&quot;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">,</span>  <span class="c1"># default</span>
        <span class="p">},</span>
        <span class="s2">&quot;waterdepth&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;waterdepth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;averagingrelsize&quot;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;pet&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;PotentialEvaporation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;infiltcap&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;InfiltrationCapacity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;roughness_chezy&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;frictioncoefficient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictype&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;roughness_manning&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;frictioncoefficient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictype&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;roughness_walllawnikuradse&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;frictioncoefficient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictype&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;roughness_whitecolebrook&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;frictioncoefficient&quot;</span><span class="p">,</span>
            <span class="s2">&quot;initype&quot;</span><span class="p">:</span> <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locationtype&quot;</span><span class="p">:</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictype&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">_FOLDERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dflowfm&quot;</span><span class="p">,</span> <span class="s2">&quot;geoms&quot;</span><span class="p">,</span> <span class="s2">&quot;maps&quot;</span><span class="p">]</span>
    <span class="n">_CLI_ARGS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;setup_region&quot;</span><span class="p">}</span>
    <span class="n">_CATALOGS</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">_DATADIR</span><span class="p">,</span> <span class="s2">&quot;parameters_data.yml&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DFlowFMModel.__init__">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.html#hydromt_delft3dfm.DFlowFMModel.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">config_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># hydromt config contain glob section, anything needed can be added here as args</span>
        <span class="n">data_libs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>  <span class="c1"># yml</span>
        <span class="n">crs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dimr_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network_snap_offset</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">snap_newbranches_to_branches_at_snapnodes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">openwater_computation_node_distance</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the DFlowFMModel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        root : str or Path</span>
<span class="sd">            The model root location.</span>
<span class="sd">        mode : {&#39;w&#39;,&#39;r&#39;,&#39;r+&#39;}</span>
<span class="sd">            Write/read/append mode.</span>
<span class="sd">            Default is &quot;w&quot;.</span>
<span class="sd">        config_fn : str, optional</span>
<span class="sd">            The D-Flow FM model configuration file (.mdu). If None, default configuration file is used.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        data_libs : list of str, optional</span>
<span class="sd">            List of data catalog yaml files.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        crs : EPSG code, int</span>
<span class="sd">            EPSG code of the model.</span>
<span class="sd">        dimr_fn: str, optional</span>
<span class="sd">            Path to the dimr configuration file. If None, default dimr configuration file is used.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        network_snap_offset: float, optional</span>
<span class="sd">            Global option for generation of the mesh1d network. Snapping tolerance to automatically connecting branches.</span>
<span class="sd">            By default 25 m.</span>
<span class="sd">        snap_newbranches_to_branches_at_snapnodes: bool, optional</span>
<span class="sd">            Global option for generation of the mesh1d network.</span>
<span class="sd">            By default True.</span>
<span class="sd">        openwater_computation_node_distance: float, optional</span>
<span class="sd">            Global option for generation of the mesh1d network. Distance to generate mesh1d nodes for open water</span>
<span class="sd">            system (rivers, channels). By default 40 m.</span>
<span class="sd">        logger</span>
<span class="sd">            The logger used to log messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;root&#39; parameter should be a of str or Path.&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">config_fn</span><span class="o">=</span><span class="n">config_fn</span><span class="p">,</span>
            <span class="n">data_libs</span><span class="o">=</span><span class="n">data_libs</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># model specific</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimr_fn</span> <span class="o">=</span> <span class="s2">&quot;dimr_config.xml&quot;</span> <span class="k">if</span> <span class="n">dimr_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dimr_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="s2">&quot;dflowfm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CONF</span><span class="p">)</span> <span class="k">if</span> <span class="n">config_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config_fn</span>
        <span class="p">)</span>  <span class="c1"># FIXME Xiaohan config needs to be derived from dimr_fn if dimr_fn exsit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">from_yml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_CATALOGS</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span>

        <span class="c1"># Global options for generation of the mesh1d network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span> <span class="o">=</span> <span class="n">network_snap_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snap_newbranches_to_branches_at_snapnodes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">snap_newbranches_to_branches_at_snapnodes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openwater_computation_node_distance</span> <span class="o">=</span> <span class="n">openwater_computation_node_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># crs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="n">crs</span><span class="p">)</span> <span class="k">if</span> <span class="n">crs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_crs</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">setup_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HYDROMT CORE METHOD NOT USED FOR DFlowFMModel.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;setup_region() method not implemented for DFlowFMModel.&quot;</span>
            <span class="s2">&quot;The region will be set in the methods preparing the mesh: &quot;</span>
            <span class="s2">&quot;[setup_mesh2d, setup_rivers, setup_rivers_from_dem, setup_channels, setup_pipes]&quot;</span>
            <span class="s2">&quot;Pass the region argument to these methods directly and not in the command line.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="DFlowFMModel.setup_channels">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_channels.html#hydromt_delft3dfm.DFlowFMModel.setup_channels">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_channels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">channels_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">channels_defaults_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;channels_defaults&quot;</span><span class="p">,</span>
        <span class="n">channel_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">friction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Manning&quot;</span><span class="p">,</span>
        <span class="n">friction_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.023</span><span class="p">,</span>
        <span class="n">crosssections_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crosssections_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">allow_intersection_snapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This component prepares the 1D channels and adds to branches 1D network.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **channels** geom: 1D channels vector</span>
<span class="sd">        * **branches** geom: 1D branches vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict, optional</span>
<span class="sd">            Dictionary describing region of interest for extracting 1D channels, e.g.:</span>

<span class="sd">            * {&#39;bbox&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">            * {&#39;geom&#39;: &#39;path/to/polygon_geometry&#39;}</span>
<span class="sd">            Note that only crs=4326 is supported for &#39;bbox&#39;.</span>
<span class="sd">        channels_fn : str</span>
<span class="sd">            Name of data source for channelsparameters, see data/data_sources.yml.</span>
<span class="sd">            Note only the lines that are intersects with the region polygon will be used.</span>
<span class="sd">            * Optional variables: [branchid, branchtype, branchorder, material, friction_type, friction_value]</span>
<span class="sd">        channels_defaults_fn : str, optional</span>
<span class="sd">            Path to a csv file containing all defaults values per &#39;branchtype&#39;.</span>
<span class="sd">            Default is None.</span>
<span class="sd">        channel_filter: str, optional</span>
<span class="sd">            Keyword in branchtype column of channels_fn used to filter river lines. If None all lines in channels_fn are used (default).</span>
<span class="sd">        friction_type : str, optional</span>
<span class="sd">            Type of friction to use. One of [&quot;Manning&quot;, &quot;Chezy&quot;, &quot;wallLawNikuradse&quot;, &quot;WhiteColebrook&quot;, &quot;StricklerNikuradse&quot;, &quot;Strickler&quot;, &quot;deBosBijkerk&quot;].</span>
<span class="sd">            By default &quot;Manning&quot;.</span>
<span class="sd">        friction_value : float, optional.</span>
<span class="sd">            Units corresponding to [friction_type] are [&quot;Chézy C [m 1/2 /s]&quot;, &quot;Manning n [s/m 1/3 ]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Strickler k_s [m 1/3 /s]&quot;, &quot;De Bos-Bijkerk γ [1/s]&quot;]</span>
<span class="sd">            Friction value. By default 0.023.</span>
<span class="sd">        crosssections_fn : str or Path, optional</span>
<span class="sd">            Name of data source for crosssections, see data/data_sources.yml.</span>
<span class="sd">            If ``crosssections_type`` = &quot;xyzpoints&quot;</span>
<span class="sd">            * Required variables: [crsid, order, z]</span>
<span class="sd">            If ``crosssections_type`` = &quot;points&quot;</span>
<span class="sd">            * Required variables: [crsid, order, z]</span>
<span class="sd">            By default None, crosssections will be set from branches</span>
<span class="sd">        crosssections_type : str, optional</span>
<span class="sd">            Type of crosssections read from crosssections_fn. One of [&quot;xyzpoints&quot;].</span>
<span class="sd">            By default None.</span>
<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolerance to automatically connecting branches.</span>
<span class="sd">            By default 0.0, no snapping is applied.</span>
<span class="sd">        allow_intersection_snapping: bool, optional</span>
<span class="sd">            Switch to choose whether snapping of multiple branch ends are allowed when ``snap_offset`` is used.</span>
<span class="sd">            By default True.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        dflowfm._setup_branches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing 1D channels.&quot;</span><span class="p">)</span>

        <span class="c1"># filter for allowed columns</span>
        <span class="n">br_type</span> <span class="o">=</span> <span class="s2">&quot;channel&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchtype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchorder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;material&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedlev&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_value&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Read data and filter within region</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region_geometry</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">gdf_br</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">channels_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Read defaults table</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">channels_defaults_fn</span><span class="p">)</span>
        <span class="c1"># Prepare branches</span>
        <span class="n">channels</span><span class="p">,</span> <span class="n">channel_nodes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_branches</span><span class="p">(</span>
            <span class="n">gdf_br</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">id_start</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">channel_filter</span><span class="p">,</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">allow_intersection_snapping</span><span class="o">=</span><span class="n">allow_intersection_snapping</span><span class="p">,</span>
            <span class="n">allowed_columns</span><span class="o">=</span><span class="n">_allowed_columns</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Prepare friction and crosssections</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_default_friction_and_crosssection</span><span class="p">(</span>
            <span class="n">channels</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">friction_type</span><span class="o">=</span><span class="n">friction_type</span><span class="p">,</span>
            <span class="n">friction_value</span><span class="o">=</span><span class="n">friction_value</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup crosssections</span>
        <span class="k">if</span> <span class="n">crosssections_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crosssections_type</span> <span class="o">=</span> <span class="s2">&quot;branch&quot;</span>  <span class="c1"># TODO: maybe assign a specific one for river, like branch_river</span>
        <span class="k">assert</span> <span class="p">{</span><span class="n">crosssections_type</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">({</span><span class="s2">&quot;xyzpoints&quot;</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">})</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_crosssections</span><span class="p">(</span>
            <span class="n">branches</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">crosssections_fn</span><span class="o">=</span><span class="n">crosssections_fn</span><span class="p">,</span>
            <span class="n">crosssections_type</span><span class="o">=</span><span class="n">crosssections_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add crosssections to exisiting ones and update geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding crosssections vector to geoms.&quot;</span><span class="p">)</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding branches and branch_nodes vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="s2">&quot;channels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">channel_nodes</span><span class="p">,</span> <span class="s2">&quot;channel_nodes&quot;</span><span class="p">)</span>

        <span class="c1"># add to branches geoms</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">channels</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_newbranches_to_branches_at_snapnodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># update mesh</span>
        <span class="c1"># Convert self.branches to xugrid</span>
        <span class="n">mesh1d</span><span class="p">,</span> <span class="n">network1d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">mesh1d_network1d_from_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opensystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closedsystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openwater_computation_node_distance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">network1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;network1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_rivers_from_dem">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_rivers_from_dem.html#hydromt_delft3dfm.DFlowFMModel.setup_rivers_from_dem">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_rivers_from_dem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">hydrography_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">river_geom_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">rivers_defaults_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rivers_defaults&quot;</span><span class="p">,</span>
        <span class="n">rivdph_method</span><span class="o">=</span><span class="s2">&quot;gvf&quot;</span><span class="p">,</span>
        <span class="n">rivwth_method</span><span class="o">=</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span>
        <span class="n">river_upa</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span>
        <span class="n">river_len</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">min_rivwth</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span>
        <span class="n">min_rivdph</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">rivbank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">rivbankq</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">segment_length</span><span class="o">=</span><span class="mf">3e3</span><span class="p">,</span>
        <span class="n">smooth_length</span><span class="o">=</span><span class="mf">10e3</span><span class="p">,</span>
        <span class="n">friction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Manning&quot;</span><span class="p">,</span>
        <span class="n">friction_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.023</span><span class="p">,</span>
        <span class="n">constrain_rivbed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">constrain_estuary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># for workflows.get_river_bathymetry method</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component sets the all river parameters from hydrograph and dem maps.</span>

<span class="sd">        River cells are based on the `river_mask_fn` raster file if `rivwth_method=&#39;mask&#39;`,</span>
<span class="sd">        or if `rivwth_method=&#39;geom&#39;` the rasterized segments buffered with half a river width</span>
<span class="sd">        (&quot;rivwth&quot; [m]) if that attribute is found in `river_geom_fn`.</span>

<span class="sd">        If a river segment geometry file `river_geom_fn` with bedlevel column (&quot;zb&quot; [m+REF]) or</span>
<span class="sd">        a river depth (&quot;rivdph&quot; [m]) in combination with `rivdph_method=&#39;geom&#39;` is provided,</span>
<span class="sd">        this attribute is used directly.</span>

<span class="sd">        Otherwise, a river depth is estimated based on bankfull discharge (&quot;qbankfull&quot; [m3/s])</span>
<span class="sd">        attribute taken from the nearest river segment in `river_geom_fn` or `qbankfull_fn`</span>
<span class="sd">        upstream river boundary points if provided.</span>

<span class="sd">        The river depth is relative to the bankfull elevation profile if `rivbank=True` (default),</span>
<span class="sd">        which is estimated as the `rivbankq` elevation percentile [0-100] of cells neighboring river cells.</span>
<span class="sd">        This option requires the flow direction (&quot;flwdir&quot;) and upstream area (&quot;uparea&quot;) maps to be set</span>
<span class="sd">        using the hydromt.flw.flwdir_from_da method. If `rivbank=False` the depth is simply subtracted</span>
<span class="sd">        from the elevation of river cells.</span>

<span class="sd">        Missing river width and river depth values are filled by propagating valid values downstream and</span>
<span class="sd">        using the constant minimum values `min_rivwth` and `min_rivdph` for the remaining missing values.</span>

<span class="sd">        Updates model layer:</span>

<span class="sd">        * **dep** map: combined elevation/bathymetry [m+ref]</span>

<span class="sd">        Adds model layers</span>

<span class="sd">        * **rivmsk** map: map of river cells (not used by SFINCS)</span>
<span class="sd">        * **rivers** geom: geometry of rivers (not used by SFINCS)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict, optional</span>
<span class="sd">            Dictionary describing region of interest for extracting 1D rivers, e.g.:</span>

<span class="sd">            * {&#39;bbox&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">            * {&#39;geom&#39;: &#39;path/to/polygon_geometry&#39;}</span>
<span class="sd">        hydrography_fn : str</span>
<span class="sd">            Hydrography data to derive river shape and characteristics from.</span>
<span class="sd">            * Required variables: [&#39;elevtn&#39;]</span>
<span class="sd">            * Optional variables: [&#39;flwdir&#39;, &#39;uparea&#39;]</span>
<span class="sd">        river_geom_fn : str, optional</span>
<span class="sd">            Line geometry with river attribute data.</span>
<span class="sd">            * Required variable for direct bed level burning: [&#39;zb&#39;]</span>
<span class="sd">            * Required variable for direct river depth burning: [&#39;rivdph&#39;] (only in combination with rivdph_method=&#39;geom&#39;)</span>
<span class="sd">            * Variables used for river depth estimates: [&#39;qbankfull&#39;, &#39;rivwth&#39;]</span>
<span class="sd">        rivers_defaults_fn : str Path</span>
<span class="sd">            Path to a csv file containing all defaults values per &#39;branchtype&#39;.</span>
<span class="sd">        rivdph_method : {&#39;gvf&#39;, &#39;manning&#39;, &#39;powlaw&#39;}</span>
<span class="sd">            River depth estimate method, by default &#39;gvf&#39;</span>
<span class="sd">        rivwth_method : {&#39;geom&#39;, &#39;mask&#39;}</span>
<span class="sd">            Derive the river with from either the `river_geom_fn` (geom) or</span>
<span class="sd">            `river_mask_fn` (mask; default) data.</span>
<span class="sd">        river_upa : float, optional</span>
<span class="sd">            Minimum upstream area threshold for rivers [km2], by default 25.0</span>
<span class="sd">        river_len: float, optional</span>
<span class="sd">            Mimimum river length within the model domain threshhold [m], by default 1000 m.</span>
<span class="sd">        min_rivwth, min_rivdph: float, optional</span>
<span class="sd">            Minimum river width [m] (by default 50.0) and depth [m] (by default 1.0)</span>
<span class="sd">        rivbank: bool, optional</span>
<span class="sd">            If True (default), approximate the reference elevation for the river depth based</span>
<span class="sd">            on the river bankfull elevation at cells neighboring river cells. Otherwise</span>
<span class="sd">            use the elevation of the local river cell as reference level.</span>
<span class="sd">        rivbankq : float, optional</span>
<span class="sd">            quantile [1-100] for river bank estimation, by default 25</span>
<span class="sd">        segment_length : float, optional</span>
<span class="sd">            Approximate river segment length [m], by default 5e3</span>
<span class="sd">        smooth_length : float, optional</span>
<span class="sd">            Approximate smoothing length [m], by default 10e3</span>
<span class="sd">        friction_type : str, optional</span>
<span class="sd">            Type of friction tu use. One of [&quot;Manning&quot;, &quot;Chezy&quot;, &quot;wallLawNikuradse&quot;, &quot;WhiteColebrook&quot;, &quot;StricklerNikuradse&quot;, &quot;Strickler&quot;, &quot;deBosBijkerk&quot;].</span>
<span class="sd">            By default &quot;Manning&quot;.</span>
<span class="sd">        friction_value : float, optional.</span>
<span class="sd">            Units corresponding to [friction_type] are [&quot;Chézy C [m 1/2 /s]&quot;, &quot;Manning n [s/m 1/3 ]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Strickler k_s [m 1/3 /s]&quot;, &quot;De Bos-Bijkerk γ [1/s]&quot;]</span>
<span class="sd">            Friction value. By default 0.023.</span>
<span class="sd">        constrain_estuary : bool, optional</span>
<span class="sd">            If True (default) fix the river depth in estuaries based on the upstream river depth.</span>
<span class="sd">        constrain_rivbed : bool, optional</span>
<span class="sd">            If True (default) correct the river bed level to be hydrologically correct,</span>
<span class="sd">            i.e. sloping downward in downstream direction.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        workflows.get_river_bathymetry</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing river shape from hydrography data.&quot;</span><span class="p">)</span>
        <span class="c1"># parse region argument</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region_geometry</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># read data</span>
        <span class="n">ds_hydro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
            <span class="n">hydrography_fn</span><span class="p">,</span>
            <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds_hydro</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">ds_hydro</span> <span class="o">=</span> <span class="n">ds_hydro</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>

        <span class="c1"># read river line geometry data</span>
        <span class="n">gdf_riv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">river_geom_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf_riv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">river_geom_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">ds_hydro</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># check if flwdir and uparea in ds_hydro</span>
        <span class="k">if</span> <span class="s2">&quot;flwdir&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_hydro</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">da_flw</span> <span class="o">=</span> <span class="n">hydromt</span><span class="o">.</span><span class="n">flw</span><span class="o">.</span><span class="n">d8_from_dem</span><span class="p">(</span><span class="n">ds_hydro</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">da_flw</span> <span class="o">=</span> <span class="n">ds_hydro</span><span class="p">[</span><span class="s2">&quot;flwdir&quot;</span><span class="p">]</span>
        <span class="n">flwdir</span> <span class="o">=</span> <span class="n">hydromt</span><span class="o">.</span><span class="n">flw</span><span class="o">.</span><span class="n">flwdir_from_da</span><span class="p">(</span><span class="n">da_flw</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;d8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;uparea&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_hydro</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="n">da_upa</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">dims</span><span class="o">=</span><span class="n">ds_hydro</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                <span class="n">coords</span><span class="o">=</span><span class="n">ds_hydro</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">flwdir</span><span class="o">.</span><span class="n">upstream_area</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;km2&quot;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;uparea&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">da_upa</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
            <span class="n">ds_hydro</span><span class="p">[</span><span class="s2">&quot;uparea&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_upa</span>

        <span class="c1"># get river shape and bathymetry</span>
        <span class="k">if</span> <span class="n">friction_type</span> <span class="o">==</span> <span class="s2">&quot;Manning&quot;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">manning</span><span class="o">=</span><span class="n">friction_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rivdph_method</span> <span class="o">==</span> <span class="s2">&quot;gvf&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;rivdph_method &#39;gvf&#39; requires friction_type=&#39;Manning&#39;. Use &#39;geom&#39; or &#39;powlaw&#39; instead.&quot;</span>
            <span class="p">)</span>
        <span class="n">gdf_riv</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get_river_bathymetry</span><span class="p">(</span>
            <span class="n">ds_hydro</span><span class="p">,</span>
            <span class="n">flwdir</span><span class="o">=</span><span class="n">flwdir</span><span class="p">,</span>
            <span class="n">gdf_riv</span><span class="o">=</span><span class="n">gdf_riv</span><span class="p">,</span>
            <span class="n">gdf_qbf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rivdph_method</span><span class="o">=</span><span class="n">rivdph_method</span><span class="p">,</span>
            <span class="n">rivwth_method</span><span class="o">=</span><span class="n">rivwth_method</span><span class="p">,</span>
            <span class="n">river_upa</span><span class="o">=</span><span class="n">river_upa</span><span class="p">,</span>
            <span class="n">river_len</span><span class="o">=</span><span class="n">river_len</span><span class="p">,</span>
            <span class="n">min_rivdph</span><span class="o">=</span><span class="n">min_rivdph</span><span class="p">,</span>
            <span class="n">min_rivwth</span><span class="o">=</span><span class="n">min_rivwth</span><span class="p">,</span>
            <span class="n">rivbank</span><span class="o">=</span><span class="n">rivbank</span><span class="p">,</span>
            <span class="n">rivbankq</span><span class="o">=</span><span class="n">rivbankq</span><span class="p">,</span>
            <span class="n">segment_length</span><span class="o">=</span><span class="n">segment_length</span><span class="p">,</span>
            <span class="n">smooth_length</span><span class="o">=</span><span class="n">smooth_length</span><span class="p">,</span>
            <span class="n">constrain_estuary</span><span class="o">=</span><span class="n">constrain_estuary</span><span class="p">,</span>
            <span class="n">constrain_rivbed</span><span class="o">=</span><span class="n">constrain_rivbed</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Rename river properties column and reproject</span>
        <span class="n">rm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;rivwth&quot;</span><span class="p">:</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;rivdph&quot;</span><span class="p">:</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;zb&quot;</span><span class="p">:</span> <span class="s2">&quot;bedlev&quot;</span><span class="p">}</span>
        <span class="n">gdf_riv</span> <span class="o">=</span> <span class="n">gdf_riv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rm_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># filter for allowed columns</span>
        <span class="n">br_type</span> <span class="o">=</span> <span class="s2">&quot;river&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchtype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchorder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;material&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diameter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedlev&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_value&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># assign default attributes</span>
        <span class="c1"># Read defaults table</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">rivers_defaults_fn</span><span class="p">)</span>
        <span class="c1"># Make sure default shape is rectangle</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;rectangle&quot;</span><span class="p">])</span>

        <span class="c1"># Prepare branches</span>
        <span class="n">rivers</span><span class="p">,</span> <span class="n">river_nodes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_branches</span><span class="p">(</span>
            <span class="n">gdf_riv</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">id_start</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">allowed_columns</span><span class="o">=</span><span class="n">_allowed_columns</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Prepare friction</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_default_friction_and_crosssection</span><span class="p">(</span>
            <span class="n">rivers</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">friction_type</span><span class="o">=</span><span class="n">friction_type</span><span class="p">,</span>
            <span class="n">friction_value</span><span class="o">=</span><span class="n">friction_value</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup crosssections</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_crosssections</span><span class="p">(</span>
            <span class="n">branches</span><span class="o">=</span><span class="n">rivers</span><span class="p">,</span>
            <span class="n">crosssections_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">crosssections_type</span><span class="o">=</span><span class="s2">&quot;branch&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add crosssections to exisiting ones and update geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding crosssections vector to geoms.&quot;</span><span class="p">)</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup geoms #TODO do we still need channels?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding rivers and river_nodes vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">river_nodes</span><span class="p">,</span> <span class="s2">&quot;rivers_nodes&quot;</span><span class="p">)</span>

        <span class="c1"># add to branches geoms</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">rivers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_newbranches_to_branches_at_snapnodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># update mesh</span>
        <span class="c1"># Convert self.branches to xugrid</span>
        <span class="n">mesh1d</span><span class="p">,</span> <span class="n">network1d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">mesh1d_network1d_from_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opensystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closedsystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openwater_computation_node_distance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">network1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;network1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_rivers">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_rivers.html#hydromt_delft3dfm.DFlowFMModel.setup_rivers">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_rivers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">rivers_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">rivers_defaults_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rivers_defaults&quot;</span><span class="p">,</span>
        <span class="n">river_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">friction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Manning&quot;</span><span class="p">,</span>
        <span class="n">friction_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.023</span><span class="p">,</span>
        <span class="n">crosssections_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crosssections_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">allow_intersection_snapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares the 1D rivers and adds to 1D branches.</span>

<span class="sd">        1D rivers must contain valid geometry, friction and crosssections.</span>

<span class="sd">        The river geometry is read from ``rivers_fn``. If defaults attributes</span>
<span class="sd">        [branchorder, spacing, material, shape, width, t_width, height, bedlev, closed] are not present in ``rivers_fn``,</span>
<span class="sd">        they are added from defaults values in ``rivers_defaults_fn``. For branchid and branchtype, they are created on the fly</span>
<span class="sd">        if not available in rivers_fn (&quot;river&quot; for Type and &quot;river_{i}&quot; for Id).</span>

<span class="sd">        Friction attributes are either taken from ``rivers_fn`` or filled in using ``friction_type`` and</span>
<span class="sd">        ``friction_value`` arguments.</span>
<span class="sd">        Note for now only branch friction or global friction is supported.</span>

<span class="sd">        Crosssections are read from ``crosssections_fn`` based on the ``crosssections_type``. If there is no</span>
<span class="sd">        ``crosssections_fn`` values are derived at the centroid of each river line based on defaults. If there are multiple</span>
<span class="sd">        types of crossections, specify them as lists.</span>

<span class="sd">        Adds/Updates model layers:</span>

<span class="sd">        * **rivers** geom: 1D rivers vector</span>
<span class="sd">        * **branches** geom: 1D branches vector</span>
<span class="sd">        * **crosssections** geom: 1D crosssection vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict, optional</span>
<span class="sd">            Dictionary describing region of interest for extracting 1D rivers, e.g.:</span>

<span class="sd">            * {&#39;bbox&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">            * {&#39;geom&#39;: &#39;path/to/polygon_geometry&#39;}</span>
<span class="sd">        rivers_fn : str</span>
<span class="sd">            Name of data source for rivers parameters, see data/data_sources.yml.</span>
<span class="sd">            Note only the lines that are intersects with the region polygon will be used.</span>
<span class="sd">            * Optional variables: [branchid, branchtype, branchorder, material, friction_type, friction_value]</span>
<span class="sd">        rivers_defaults_fn : str Path</span>
<span class="sd">            Path to a csv file containing all defaults values per &#39;branchtype&#39;.</span>
<span class="sd">            By default None.</span>
<span class="sd">        river_filter: str, optional</span>
<span class="sd">            Keyword in branchtype column of rivers_fn used to filter river lines. If None all lines in rivers_fn are used (default).</span>
<span class="sd">        friction_type : str, optional</span>
<span class="sd">            Type of friction to use. One of [&quot;Manning&quot;, &quot;Chezy&quot;, &quot;wallLawNikuradse&quot;, &quot;WhiteColebrook&quot;, &quot;StricklerNikuradse&quot;, &quot;Strickler&quot;, &quot;deBosBijkerk&quot;].</span>
<span class="sd">            By default &quot;Manning&quot;.</span>
<span class="sd">        friction_value : float, optional.</span>
<span class="sd">            Units corresponding to [friction_type] are [&quot;Chézy C [m 1/2 /s]&quot;, &quot;Manning n [s/m 1/3 ]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Strickler k_s [m 1/3 /s]&quot;, &quot;De Bos-Bijkerk γ [1/s]&quot;]</span>
<span class="sd">            Friction value. By default 0.023.</span>
<span class="sd">        crosssections_fn : str, Path, or a list of str or Path, optional</span>
<span class="sd">            Name of data source for crosssections, see data/data_sources.yml. One or a list corresponding to ``crosssections_type`` .</span>
<span class="sd">            If ``crosssections_type`` = &quot;branch&quot;</span>
<span class="sd">            crosssections_fn should be None</span>
<span class="sd">            If ``crosssections_type`` = &quot;xyz&quot;</span>
<span class="sd">            * Required variables: [crsid, order, z]</span>
<span class="sd">            If ``crosssections_type`` = &quot;point&quot;</span>
<span class="sd">            * Required variables: [crsid, shape, shift]</span>
<span class="sd">            By default None, crosssections will be set from branches</span>
<span class="sd">        crosssections_type : str, or a list of str, optional</span>
<span class="sd">            Type of crosssections read from crosssections_fn. One or a list of [&quot;branch&quot;, &quot;xyz&quot;, &quot;point&quot;].</span>
<span class="sd">            By default None.</span>
<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolerance to automatically connecting branches.</span>
<span class="sd">            By default 0.0, no snapping is applied.</span>
<span class="sd">        allow_intersection_snapping: bool, optional</span>
<span class="sd">            Switch to choose whether snapping of multiple branch ends are allowed when ``snap_offset`` is used.</span>
<span class="sd">            By default True.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        dflowfm._setup_branches</span>
<span class="sd">        dflowfm._setup_crosssections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing 1D rivers.&quot;</span><span class="p">)</span>
        <span class="c1"># filter for allowed columns</span>
        <span class="n">br_type</span> <span class="o">=</span> <span class="s2">&quot;river&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchtype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchorder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;material&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedlev&quot;</span><span class="p">,</span>
            <span class="s2">&quot;closed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction_value&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Read data and filter within region</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region_geometry</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">gdf_br</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">rivers_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Read defaults table</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">rivers_defaults_fn</span><span class="p">)</span>
        <span class="c1"># Prepare branches</span>
        <span class="n">rivers</span><span class="p">,</span> <span class="n">river_nodes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_branches</span><span class="p">(</span>
            <span class="n">gdf_br</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">id_start</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">river_filter</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">allow_intersection_snapping</span><span class="o">=</span><span class="n">allow_intersection_snapping</span><span class="p">,</span>
            <span class="n">allowed_columns</span><span class="o">=</span><span class="n">_allowed_columns</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Prepare friction and crosssections</span>
        <span class="n">rivers</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_default_friction_and_crosssection</span><span class="p">(</span>
            <span class="n">rivers</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">friction_type</span><span class="o">=</span><span class="n">friction_type</span><span class="p">,</span>
            <span class="n">friction_value</span><span class="o">=</span><span class="n">friction_value</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup crosssections</span>
        <span class="n">crosssections_type</span><span class="p">,</span> <span class="n">crosssections_fn</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">init_crosssections_options</span><span class="p">(</span>
            <span class="n">crosssections_type</span><span class="p">,</span> <span class="n">crosssections_fn</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">crs_fn</span><span class="p">,</span> <span class="n">crs_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">crosssections_fn</span><span class="p">,</span> <span class="n">crosssections_type</span><span class="p">):</span>
            <span class="n">crosssections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_crosssections</span><span class="p">(</span>
                <span class="n">branches</span><span class="o">=</span><span class="n">rivers</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">crosssections_fn</span><span class="o">=</span><span class="n">crs_fn</span><span class="p">,</span>
                <span class="n">crosssections_type</span><span class="o">=</span><span class="n">crs_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
            <span class="p">)</span>
            <span class="c1"># setup geoms for crosssections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup branch orders</span>
        <span class="c1"># for crossection type yz or xyz, always use branchorder = -1, because no interpolation can be applied.</span>
        <span class="c1"># TODO: change to lower case is needed</span>
        <span class="n">_overwrite_branchorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;crosssections&quot;</span><span class="p">][</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;crosssections&quot;</span><span class="p">][</span><span class="s2">&quot;crsdef_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;yz&quot;</span><span class="p">)</span>
        <span class="p">][</span><span class="s2">&quot;crsdef_branchid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_overwrite_branchorder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rivers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">rivers</span><span class="p">[</span><span class="s2">&quot;branchid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">_overwrite_branchorder</span><span class="p">),</span> <span class="s2">&quot;branchorder&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># setup geoms for rivers and river_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding rivers and river_nodes vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">rivers</span><span class="p">,</span> <span class="s2">&quot;rivers&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">river_nodes</span><span class="p">,</span> <span class="s2">&quot;rivers_nodes&quot;</span><span class="p">)</span>

        <span class="c1"># setup branches</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;mesh1d&quot;</span>
            <span class="p">),</span>  <span class="c1"># FIXME Xiaohan self.get_mesh(&quot;mesh1d&quot;) gives an error, is that desired?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">rivers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_newbranches_to_branches_at_snapnodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># update mesh</span>
        <span class="c1"># Convert self.branches to xugrid</span>
        <span class="n">mesh1d</span><span class="p">,</span> <span class="n">network1d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">mesh1d_network1d_from_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opensystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closedsystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openwater_computation_node_distance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">network1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;network1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_pipes">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_pipes.html#hydromt_delft3dfm.DFlowFMModel.setup_pipes">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_pipes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">pipes_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pipes_defaults_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pipes_defaults&quot;</span><span class="p">,</span>
        <span class="n">pipe_filter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">friction_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;WhiteColebrook&quot;</span><span class="p">,</span>
        <span class="n">friction_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.003</span><span class="p">,</span>
        <span class="n">crosssections_shape</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span>
        <span class="n">crosssections_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">dem_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pipes_depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">pipes_invlev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">allow_intersection_snapping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares the 1D pipes and adds to 1D branches.</span>
<span class="sd">        Note that 1D manholes must also be set-up  when setting up 1D pipes.</span>

<span class="sd">        1D pipes must contain valid geometry, friction and crosssections.</span>

<span class="sd">        The pipe geometry is read from ``pipes_fn``.</span>
<span class="sd">        if branchtype is present in ``pipes_fn``, it is possible to filter pipe geometry using an additional filter specificed in``pipe_filter``.</span>
<span class="sd">        If defaults attributes [&quot;branchorder&quot;] are not present in ``pipes_fn``, they are added from defaults values in ``pipes_defaults_fn``.</span>
<span class="sd">        For branchid and branchtype, if they are not present in ``pipes_fn``, they are created on the fly (&quot;pipe&quot; for branchtype and &quot;pipe_{i}&quot; for branchid).</span>
<span class="sd">        The pipe geometry can be processed using splitting based on ``spacing``.</span>

<span class="sd">        Friction attributes [&quot;branchid&quot;, &quot;frictionvalue&quot;] are either taken from ``pipes_fn`` or filled in using ``friction_type`` and</span>
<span class="sd">        ``friction_value`` arguments.</span>
<span class="sd">        Note for now only branch friction or global friction is supported.</span>

<span class="sd">        Crosssections definition attributes [&quot;shape&quot;, &quot;diameter&quot;, &quot;width&quot;, &quot;height&quot;, &quot;closed&quot;] are either taken from ``pipes_fn`` or filled in using ``crosssections_shape`` and ``crosssections_value``.</span>
<span class="sd">        Crosssections location attributes [&quot;invlev_up&quot;, &quot;invlev_dn&quot;] are either taken from ``pipes_fn``, or derived from ``dem_fn`` minus a fixed depth ``pipe_depth`` [m], or from a constant ``pipe_invlev`` [m asl] (not recommended! should be edited before a model run).</span>

<span class="sd">        Adds/Updates model layers:</span>

<span class="sd">        * **pipes** geom: 1D pipes vector</span>
<span class="sd">        * **branches** geom: 1D branches vector</span>
<span class="sd">        * **crosssections** geom: 1D crosssection vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict, optional</span>
<span class="sd">            Dictionary describing region of interest for extracting 1D pipes, e.g.:</span>

<span class="sd">            * {&#39;bbox&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">            * {&#39;geom&#39;: &#39;path/to/polygon_geometry&#39;}</span>
<span class="sd">            Note that only manholes within the region are kept.</span>
<span class="sd">        pipes_fn : str</span>
<span class="sd">            Name of data source for pipes parameters, see data/data_sources.yml.</span>
<span class="sd">            Note only the lines that are within the region polygon will be used.</span>
<span class="sd">            * Optional variables: [branchid, branchtype, branchorder, spacing, branchid, frictionvalue, shape, diameter, width, height, closed, invlev_up, invlev_dn]</span>
<span class="sd">            #TODO: material table is used for friction which is not implemented</span>
<span class="sd">        pipes_defaults_fn : str Path</span>
<span class="sd">            Path to a csv file containing all defaults values per &quot;branchtype&quot;&#39;&quot;.</span>
<span class="sd">        pipe_filter: str, optional</span>
<span class="sd">            Keyword in branchtype column of pipes_fn used to filter pipe lines. If None all lines in pipes_fn are used (default).</span>
<span class="sd">        spacing: float, optional</span>
<span class="sd">            Spacing value in meters to split the long pipelines lines into shorter pipes. By default inf - no splitting is applied.</span>
<span class="sd">        friction_type : str, optional</span>
<span class="sd">            Type of friction to use. One of [&quot;Manning&quot;, &quot;Chezy&quot;, &quot;wallLawNikuradse&quot;, &quot;WhiteColebrook&quot;, &quot;StricklerNikuradse&quot;, &quot;Strickler&quot;, &quot;deBosBijkerk&quot;].</span>
<span class="sd">            By default &quot;WhiteColeBrook&quot;.</span>
<span class="sd">        friction_value : float, optional.</span>
<span class="sd">            Units corresponding to &#39;&#39;friction_type&#39;&#39; are [&quot;Chézy C [m 1/2 /s]&quot;, &quot;Manning n [s/m 1/3 ]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Nikuradse k_n [m]&quot;, &quot;Strickler k_s [m 1/3 /s]&quot;, &quot;De Bos-Bijkerk γ [1/s]&quot;]</span>
<span class="sd">            Friction value. By default 0.003.</span>
<span class="sd">        crosssections_shape : str, optional</span>
<span class="sd">            Shape of pipe crosssections. Either &quot;circle&quot; (default) or &quot;rectangle&quot;.</span>
<span class="sd">        crosssections_value : int or list of int, optional</span>
<span class="sd">            Crosssections parameter value.</span>
<span class="sd">            If ``crosssections_shape`` = &quot;circle&quot;, expects a diameter (default with 0.5 m) [m]</span>
<span class="sd">            If ``crosssections_shape`` = &quot;rectangle&quot;, expects a list with [width, height] (e.g. [1.0, 1.0]) [m]. closed rectangle by default.</span>
<span class="sd">        dem_fn: str, optional</span>
<span class="sd">            Name of data source for dem data. Used to derive default invert levels values (DEM - pipes_depth - pipes diameter/height).</span>
<span class="sd">            * Required variables: [elevtn]</span>
<span class="sd">        pipes_depth: float, optional</span>
<span class="sd">            Depth of the pipes underground [m] (default 2.0 m). Used to derive defaults invert levels values (DEM - pipes_depth - pipes diameter/height).</span>
<span class="sd">        pipes_invlev: float, optional</span>
<span class="sd">            Constant default invert levels of the pipes [m asl] (default -2.5 m asl). This method is recommended to be used together with the dem method to fill remaining nan values. It slone is not a recommended method.</span>
<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolenrance to automatically connecting branches. Tolenrance must be smaller than the shortest pipe length.</span>
<span class="sd">            By default 0.0, no snapping is applied.</span>
<span class="sd">        allow_intersection_snapping: bool, optional</span>
<span class="sd">            Switch to choose whether snapping of multiple branch ends are allowed when ``snap_offset`` is used.</span>
<span class="sd">            By default True.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        dflowfm._setup_branches</span>
<span class="sd">        dflowfm._setup_crosssections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing 1D pipes.&quot;</span><span class="p">)</span>

        <span class="c1"># filter for allowed columns</span>
        <span class="n">br_type</span> <span class="o">=</span> <span class="s2">&quot;pipe&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchtype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchorder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;material&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spacing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictionvalue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>  <span class="c1"># circle or rectangle</span>
            <span class="s2">&quot;diameter&quot;</span><span class="p">,</span>  <span class="c1"># circle</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>  <span class="c1"># rectangle</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>  <span class="c1"># rectangle</span>
            <span class="s2">&quot;invlev_up&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inlev_dn&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Read data and filter within region</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">parse_region_geometry</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">gdf_br</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">pipes_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Read defaults table</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">pipes_defaults_fn</span><span class="p">)</span>
        <span class="c1"># Prepare branches</span>
        <span class="n">pipes</span><span class="p">,</span> <span class="n">pipe_nodes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_branches</span><span class="p">(</span>
            <span class="n">gdf_br</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">id_start</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">pipe_filter</span><span class="p">,</span>
            <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">allow_intersection_snapping</span><span class="o">=</span><span class="n">allow_intersection_snapping</span><span class="p">,</span>
            <span class="n">allowed_columns</span><span class="o">=</span><span class="n">_allowed_columns</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Prepare friction and crosssections</span>
        <span class="n">pipes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_default_friction_and_crosssection</span><span class="p">(</span>
            <span class="n">pipes</span><span class="p">,</span>
            <span class="n">br_type</span><span class="o">=</span><span class="n">br_type</span><span class="p">,</span>
            <span class="n">friction_type</span><span class="o">=</span><span class="n">friction_type</span><span class="p">,</span>
            <span class="n">friction_value</span><span class="o">=</span><span class="n">friction_value</span><span class="p">,</span>
            <span class="n">crosssections_shape</span><span class="o">=</span><span class="n">crosssections_shape</span><span class="p">,</span>
            <span class="n">crosssections_value</span><span class="o">=</span><span class="n">crosssections_value</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># filter extra time for geting clipped pipes within the region (better match)</span>
        <span class="n">pipes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">pipes</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;within&quot;</span><span class="p">)</span>

        <span class="c1"># setup crosssections</span>
        <span class="c1"># setup invert levels</span>
        <span class="c1"># 1. check if invlev up and dn are fully filled in (nothing needs to be done)</span>
        <span class="k">if</span> <span class="s2">&quot;invlev_up&quot;</span> <span class="ow">and</span> <span class="s2">&quot;invlev_dn&quot;</span> <span class="ow">in</span> <span class="n">pipes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">pipes</span><span class="p">[[</span><span class="s2">&quot;invlev_up&quot;</span><span class="p">,</span> <span class="s2">&quot;invlev_dn&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># nodata values in pipes for invert levels</span>
                <span class="n">fill_invlev</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipes_fn</span><span class="si">}</span><span class="s2"> data has </span><span class="si">{</span><span class="n">inv</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> no data values for invert levels. Will be filled using dem_fn or default value </span><span class="si">{</span><span class="n">pipes_invlev</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fill_invlev</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_invlev</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipes_fn</span><span class="si">}</span><span class="s2"> does not have columns [invlev_up, invlev_dn]. Invert levels will be generated from dem_fn or default value </span><span class="si">{</span><span class="n">pipes_invlev</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># 2. filling use dem_fn + pipe_depth</span>
        <span class="k">if</span> <span class="n">fill_invlev</span> <span class="ow">and</span> <span class="n">dem_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">dem_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">pipes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">invert_levels_from_dem</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">=</span><span class="n">pipes</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="n">dem</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">pipes_depth</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">pipes</span><span class="p">[[</span><span class="s2">&quot;invlev_up&quot;</span><span class="p">,</span> <span class="s2">&quot;invlev_dn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fill_invlev</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fill_invlev</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># 3. filling use pipes_invlev</span>
        <span class="k">if</span> <span class="n">fill_invlev</span> <span class="ow">and</span> <span class="n">pipes_invlev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;!Using a constant up and down invert levels for all pipes. May cause issues when running the delft3dfm model.!&quot;</span>
            <span class="p">)</span>
            <span class="n">df_inv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;branchtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pipe&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;invlev_up&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pipes_invlev</span><span class="p">],</span>
                    <span class="s2">&quot;invlev_dn&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pipes_invlev</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">pipes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">update_data_columns_attributes</span><span class="p">(</span>
                <span class="n">pipes</span><span class="p">,</span> <span class="n">df_inv</span><span class="p">,</span> <span class="n">brtype</span><span class="o">=</span><span class="s2">&quot;pipe&quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO: check that geometry lines are properly oriented from up to dn when deriving invert levels from dem</span>

        <span class="c1"># Update crosssections object</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_crosssections</span><span class="p">(</span>
            <span class="n">pipes</span><span class="p">,</span>
            <span class="n">crosssections_type</span><span class="o">=</span><span class="s2">&quot;branch&quot;</span><span class="p">,</span>
            <span class="n">midpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add crosssections to exisiting ones and update geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding crosssections vector to geoms.&quot;</span><span class="p">)</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding pipes and pipe_nodes vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">pipes</span><span class="p">,</span> <span class="s2">&quot;pipes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">pipe_nodes</span><span class="p">,</span> <span class="s2">&quot;pipe_nodes&quot;</span><span class="p">)</span>  <span class="c1"># TODO: for manholes</span>

        <span class="c1"># add to branches</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">pipes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_newbranches_to_branches_at_snapnodes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">workflows</span><span class="o">.</span><span class="n">validate_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># update mesh</span>
        <span class="c1"># Convert self.branches to xugrid</span>
        <span class="n">mesh1d</span><span class="p">,</span> <span class="n">network1d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">mesh1d_network1d_from_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opensystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closedsystem</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openwater_computation_node_distance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">network1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;network1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh1d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh1d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_setup_crosssections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">branches</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crosssections_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crosssections_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;branch&quot;</span><span class="p">,</span>
        <span class="n">midpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares 1D crosssections.</span>
<span class="sd">        crosssections can be set from branches, points and xyz, # TODO to be extended also from dem data for rivers/channels?</span>
<span class="sd">        Crosssection must only be used after friction has been setup.</span>

<span class="sd">        Crosssections are read from ``crosssections_fn``.</span>
<span class="sd">        Crosssection types of this file is read from ``crosssections_type``</span>

<span class="sd">        If ``crosssections_fn`` is not defined, default method is ``crosssections_type`` = &#39;branch&#39;,</span>
<span class="sd">        meaning that branch attributes will be used to derive regular crosssections.</span>
<span class="sd">        Crosssections are derived at branches mid points if ``midpoints`` is True,</span>
<span class="sd">        else at both upstream and downstream extremities of branches if False.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">        * **crosssections** geom: 1D crosssection vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        branches : gpd.GeoDataFrame</span>
<span class="sd">            geodataframe of the branches to apply crosssections.</span>
<span class="sd">            * Required variables: [branchid, branchtype, branchorder]</span>
<span class="sd">            If ``crosssections_type`` = &quot;branch&quot;</span>
<span class="sd">                if shape = &#39;circle&#39;: &#39;diameter&#39;</span>
<span class="sd">                if shape = &#39;rectangle&#39;: &#39;width&#39;, &#39;height&#39;, &#39;closed&#39;</span>
<span class="sd">                if shape = &#39;trapezoid&#39;: &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;</span>
<span class="sd">            * Optional variables: [material, friction_type, friction_value]</span>
<span class="sd">        region : gpd.GeoDataFrame, optional</span>
<span class="sd">            geodataframe of the region of interest for extracting crosssections_fn, by default None</span>
<span class="sd">        crosssections_fn : str Path, optional</span>
<span class="sd">            Name of data source for crosssections, see data/data_sources.yml.</span>
<span class="sd">            Note that for point crossections, only ones within the snap_network_offset will be used.</span>
<span class="sd">            If ``crosssections_type`` = &quot;xyz&quot;</span>
<span class="sd">            Note that only points within the region + 1000m buffer will be read.</span>
<span class="sd">            * Required variables: crsid, order, z</span>
<span class="sd">            * Optional variables:</span>
<span class="sd">            If ``crosssections_type`` = &quot;point&quot;</span>
<span class="sd">            * Required variables: crsid, shape, shift</span>
<span class="sd">            * Optional variables:</span>
<span class="sd">                if shape = &#39;rectangle&#39;: &#39;width&#39;, &#39;height&#39;, &#39;closed&#39;</span>
<span class="sd">                if shape = &#39;trapezoid&#39;: &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;</span>
<span class="sd">                if shape = &#39;yz&#39;: &#39;yzcount&#39;,&#39;ycoordinates&#39;,&#39;zcoordinates&#39;,&#39;closed&#39;</span>
<span class="sd">                if shape = &#39;zw&#39;: &#39;numlevels&#39;, &#39;levels&#39;, &#39;flowwidths&#39;,&#39;totalwidths&#39;, &#39;closed&#39;.</span>
<span class="sd">                if shape = &#39;zwRiver&#39;: Not Supported</span>
<span class="sd">                Note that list input must be strings seperated by a whitespace &#39;&#39;.</span>
<span class="sd">            By default None, crosssections will be set from branches</span>
<span class="sd">        crosssections_type : {&#39;branch&#39;, &#39;xyz&#39;, &#39;point&#39;}</span>
<span class="sd">            Type of crosssections read from crosssections_fn. One of [&#39;branch&#39;, &#39;xyz&#39;, &#39;point&#39;].</span>
<span class="sd">            By default `branch`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gdf_cs : gpd.GeoDataFrame</span>
<span class="sd">            geodataframe of the new cross-sections</span>

<span class="sd">        Raise:</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError: if ``crosssection_type`` is not recongnised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># setup crosssections</span>
        <span class="k">if</span> <span class="n">crosssections_fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">crosssections_type</span> <span class="o">==</span> <span class="s2">&quot;branch&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: set a seperate type for rivers because other branch types might require upstream/downstream</span>
            <span class="c1"># TODO: check for required columns</span>
            <span class="c1"># read crosssection from branches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing crossections from branch.&quot;</span><span class="p">)</span>
            <span class="n">gdf_cs</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">set_branch_crosssections</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="n">midpoint</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">crosssections_type</span> <span class="o">==</span> <span class="s2">&quot;xyz&quot;</span><span class="p">:</span>
            <span class="c1"># Read the crosssection data</span>
            <span class="n">gdf_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">crosssections_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># check if feature valid</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_cs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">crosssections_fn</span><span class="si">}</span><span class="s2"> 1D xyz crosssections found within domain&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">valid_attributes</span> <span class="o">=</span> <span class="n">gis_utils</span><span class="o">.</span><span class="n">check_gpd_attributes</span><span class="p">(</span>
                <span class="n">gdf_cs</span><span class="p">,</span> <span class="n">required_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;crsid&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Required attributes [crsid, order, z] in xyz crosssections do not exist&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># assign id</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="s2">&quot;crsid&quot;</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gdf_cs</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">id_col</span>

            <span class="c1"># reproject to model crs</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

            <span class="c1"># set crsloc and crsdef attributes to crosssections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing 1D xyz crossections from </span><span class="si">{</span><span class="n">crosssections_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gdf_cs</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">set_xyz_crosssections</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">gdf_cs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">crosssections_type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
            <span class="c1"># Read the crosssection data</span>
            <span class="n">gdf_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">crosssections_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># check if feature valid</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_cs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">crosssections_fn</span><span class="si">}</span><span class="s2"> 1D point crosssections found within domain&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">valid_attributes</span> <span class="o">=</span> <span class="n">gis_utils</span><span class="o">.</span><span class="n">check_gpd_attributes</span><span class="p">(</span>
                <span class="n">gdf_cs</span><span class="p">,</span> <span class="n">required_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;crsid&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;shift&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Required attributes [crsid, shape, shift] in point crosssections do not exist&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># assign id</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="s2">&quot;crsid&quot;</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">gdf_cs</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">id_col</span>

            <span class="c1"># reproject to model crs</span>
            <span class="n">gdf_cs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

            <span class="c1"># set crsloc and crsdef attributes to crosssections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing 1D point crossections from </span><span class="si">{</span><span class="n">crosssections_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gdf_cs</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">set_point_crosssections</span><span class="p">(</span>
                <span class="n">branches</span><span class="p">,</span> <span class="n">gdf_cs</span><span class="p">,</span> <span class="n">maxdist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">crosssections_type</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gdf_cs</span>

<div class="viewcode-block" id="DFlowFMModel.setup_manholes">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_manholes.html#hydromt_delft3dfm.DFlowFMModel.setup_manholes">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_manholes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">manholes_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manhole_defaults_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;manholes_defaults&quot;</span><span class="p">,</span>
        <span class="n">bedlevel_shift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">dem_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the 1D manholes to pipes or tunnels. Can only be used after all branches are setup.</span>

<span class="sd">        The manholes are generated based on a set of standards specified in ``manhole_defaults_fn`` (default)  and can be overwritten with manholes read from ``manholes_fn``.</span>

<span class="sd">        Use ``manholes_fn`` to set the manholes from a dataset of point locations.</span>
<span class="sd">        Only locations within the model region are selected. They are snapped to the model</span>
<span class="sd">        network nodes locations within a max distance defined in ``snap_offset``.</span>

<span class="sd">        Manhole attributes [&quot;area&quot;, &quot;streetstoragearea&quot;, &quot;storagetype&quot;, &quot;streetlevel&quot;] are either taken from ``manholes_fn`` or filled in using defaults in ``manhole_defaults_fn``.</span>
<span class="sd">        Manhole attribute [&quot;bedlevel&quot;] is always generated from invert levels of the pipe/tunnel network plus a shift defined in ``bedlevel_shift``. This is needed for numerical stability.</span>
<span class="sd">        Manhole attribute [&quot;streetlevel&quot;]  can also be overwriten with values dervied from &quot;dem_fn&quot;.</span>
<span class="sd">        #TODO probably needs another parameter to apply different sampling method for the manholes, e.g. min within 2 m radius.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **manholes** geom: 1D manholes vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        manholes_fn: str Path, optional</span>
<span class="sd">            Path or data source name for manholes see data/data_sources.yml.</span>
<span class="sd">            Note only the points that are within the region polygon will be used.</span>

<span class="sd">            * Optional variables: [&quot;area&quot;, &quot;streetstoragearea&quot;, &quot;storagetype&quot;, &quot;streetlevel&quot;]</span>
<span class="sd">        manholes_defaults_fn : str Path, optional</span>
<span class="sd">            Path to a csv file containing all defaults values per &quot;branchtype&quot;.</span>
<span class="sd">            Use multiple rows to apply defaults per [&quot;shape&quot;, &quot;diameter&quot;/&quot;width&quot;] pairs.</span>
<span class="sd">            By default `hydrolib.hydromt_delft3dfm.data.manholes.manholes_defaults.csv` is used.</span>

<span class="sd">            * Allowed variables: [&quot;area&quot;, &quot;streetlevel&quot;, &quot;streeStorageArea&quot;, &quot;storagetype&quot;]</span>
<span class="sd">        dem_fn: str, optional</span>
<span class="sd">            Name of data source for dem data. Used to derive default invert levels values (DEM - pipes_depth - pipes diameter/height).</span>
<span class="sd">            * Required variables: [elevtn]</span>
<span class="sd">        bedlevel_shift: float, optional</span>
<span class="sd">            Shift applied to lowest pipe invert levels to derive manhole bedlevels [m] (default -0.5 m, meaning bedlevel = pipe invert - 0.5m).</span>
<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolenrance to automatically connecting manholes to network nodes.</span>
<span class="sd">            By default 0.001. Use a higher value if large number of user manholes are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># geom columns for manholes</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>  <span class="c1"># storage node id, considered identical to manhole id when using single compartment manholes</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;manholeid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nodeid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;streetlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;streetstoragearea&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storagetype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;usetable&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># generate manhole locations and bedlevels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;generating manholes locations and bedlevels. &quot;</span><span class="p">)</span>
        <span class="n">manholes</span><span class="p">,</span> <span class="n">branches</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">generate_manholes_on_branches</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">bedlevel_shift</span><span class="o">=</span><span class="n">bedlevel_shift</span><span class="p">,</span>
            <span class="n">use_branch_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">],</span>
            <span class="n">id_prefix</span><span class="o">=</span><span class="s2">&quot;manhole_&quot;</span><span class="p">,</span>
            <span class="n">id_suffix</span><span class="o">=</span><span class="s2">&quot;_generated&quot;</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># FIXME Xiaohan: why do we need set_branches here? Because of branches.gui --&gt; add a high level write_gui files same level as write_mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_branches</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># add manhole attributes from defaults</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">manhole_defaults_fn</span><span class="p">)</span>

        <span class="c1"># add defaults</span>
        <span class="n">manholes</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">update_data_columns_attributes</span><span class="p">(</span><span class="n">manholes</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>

        <span class="c1"># read user manhole</span>
        <span class="k">if</span> <span class="n">manholes_fn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading manholes street level from file </span><span class="si">{</span><span class="n">manholes_fn</span><span class="si">}</span><span class="s2">. &quot;</span><span class="p">)</span>
            <span class="c1"># read</span>
            <span class="n">gdf_manhole</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">manholes_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># reproject</span>
            <span class="k">if</span> <span class="n">gdf_manhole</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">gdf_manhole</span> <span class="o">=</span> <span class="n">gdf_manhole</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="c1"># filter for allowed columns</span>
            <span class="n">allowed_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_allowed_columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">gdf_manhole</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;filtering for allowed columns:</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">gdf_manhole</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="n">gdf_manhole</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed_columns</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">gdf_manhole</span><span class="o">.</span><span class="n">crs</span>
            <span class="p">)</span>
            <span class="c1"># replace generated manhole using user manholes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;overwriting generated manholes using user manholes.&quot;</span><span class="p">)</span>
            <span class="n">manholes</span> <span class="o">=</span> <span class="n">hydromt</span><span class="o">.</span><span class="n">gis_utils</span><span class="o">.</span><span class="n">nearest_merge</span><span class="p">(</span>
                <span class="n">manholes</span><span class="p">,</span> <span class="n">gdf_manhole</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># generate manhole streetlevels from dem</span>
        <span class="k">if</span> <span class="n">dem_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;overwriting manholes street level from dem. &quot;</span><span class="p">)</span>
            <span class="n">dem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">dem_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;elevtn&quot;</span><span class="p">],</span>
                <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># reproject of manholes is done in sample method</span>
            <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;_streetlevel_dem&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">manholes</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;_streetlevel_dem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;streetlevel&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;streetlevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;_streetlevel_dem&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;street level mean is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;streetlevel&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="c1"># internal administration</span>
        <span class="c1"># drop duplicated manholeid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dropping duplicated manholeid&quot;</span><span class="p">)</span>
        <span class="n">manholes</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;manholeid&quot;</span><span class="p">)</span>
        <span class="c1"># add nodeid to manholes</span>
        <span class="n">network1d_nodes</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">network1d_nodes_geodataframe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">manholes</span> <span class="o">=</span> <span class="n">hydromt</span><span class="o">.</span><span class="n">gis_utils</span><span class="o">.</span><span class="n">nearest_merge</span><span class="p">(</span>
            <span class="n">manholes</span><span class="p">,</span> <span class="n">network1d_nodes</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># add additional required columns</span>
        <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manholes</span><span class="p">[</span>
            <span class="s2">&quot;nodeid&quot;</span>
        <span class="p">]</span>  <span class="c1"># id of the storage nodes id, identical to manholeid when single compartment manholes are used</span>
        <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;manholeid&quot;</span><span class="p">]</span>
        <span class="n">manholes</span><span class="p">[</span><span class="s2">&quot;usetable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># validate</span>
        <span class="k">if</span> <span class="n">manholes</span><span class="p">[</span><span class="n">_allowed_columns</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;manholes contain no data. use manholes_defaults_fn to apply no data filling.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># setup geoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding manholes vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">manholes</span><span class="p">,</span> <span class="s2">&quot;manholes&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_1dboundary">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_1dboundary.html#hydromt_delft3dfm.DFlowFMModel.setup_1dboundary">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_1dboundary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boundaries_geodataset_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundaries_timeseries_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundary_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span>
        <span class="n">branch_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;river&quot;</span><span class="p">,</span>
        <span class="n">boundary_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;waterlevel&quot;</span><span class="p">,</span>
        <span class="n">boundary_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="n">boundary_locs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;downstream&quot;</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the 1D ``boundary_type`` boundaries to branches using timeseries or a constant for a</span>
<span class="sd">        specific ``branch_type`` at the ``boundary_locs`` locations.</span>
<span class="sd">        E.g. &#39;waterlevel&#39; boundaries for &#39;downstream&#39;&#39;river&#39; branches.</span>

<span class="sd">        The values can either be a constant using ``boundary_value`` (default) or timeseries read from ``boundaries_geodataset_fn``.</span>

<span class="sd">        Use ``boundaries_geodataset_fn`` to set the boundary values from a dataset of point location</span>
<span class="sd">        timeseries. Only locations within the possible model boundary locations + snap_offset are used. They are snapped to the model</span>
<span class="sd">        boundary locations within a max distance defined in ``snap_offset``. If ``boundaries_geodataset_fn``</span>
<span class="sd">        has missing values, the constant ``boundary_value`` will be used.</span>

<span class="sd">        The dataset/timeseries are clipped to the model time based on the model config</span>
<span class="sd">        tstart and tstop entries.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **boundary1d_{boundary_type}bnd_{branch_type}** forcing: 1D boundaries DataArray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        boundaries_geodataset_fn : str, Path</span>
<span class="sd">            Path or data source name for geospatial point timeseries file.</span>
<span class="sd">            This can either be a netcdf file with geospatial coordinates</span>
<span class="sd">            or a combined point location file with a timeseries data csv file</span>
<span class="sd">            which can be setup through the data_catalog yml file.</span>

<span class="sd">            * Required variables if netcdf: [&#39;discharge&#39;, &#39;waterlevel&#39;] depending on ``boundary_type``</span>
<span class="sd">            * Required coordinates if netcdf: [&#39;time&#39;, &#39;index&#39;, &#39;y&#39;, &#39;x&#39;]</span>

<span class="sd">            * Required variables if a combined point location file: [&#39;index&#39;] with type int</span>
<span class="sd">            * Required index types if a time series data csv file: int</span>
<span class="sd">            NOTE: Require equidistant time series</span>
<span class="sd">        boundaries_timeseries_fn: str, Path</span>
<span class="sd">            Path to tabulated timeseries csv file with time index in first column</span>
<span class="sd">            and location IDs in the first row,</span>
<span class="sd">            see :py:meth:`hydromt.open_timeseries_from_table`, for details.</span>
<span class="sd">            NOTE: tabulated timeseries files can only in combination with point location</span>
<span class="sd">            coordinates be set as a geodataset in the data_catalog yml file.</span>
<span class="sd">            NOTE: Require equidistant time series</span>
<span class="sd">        boundary_value : float, optional</span>
<span class="sd">            Constant value to use for all boundaries if ``boundaries_geodataset_fn`` is None and to</span>
<span class="sd">            fill in missing data. By default -2.5 m.</span>
<span class="sd">        branch_type: str</span>
<span class="sd">            Type of branch to apply boundaries on. One of [&quot;river&quot;, &quot;pipe&quot;].</span>
<span class="sd">        boundary_type : str, optional</span>
<span class="sd">            Type of boundary tu use. One of [&quot;waterlevel&quot;, &quot;discharge&quot;].</span>
<span class="sd">            By default &quot;waterlevel&quot;.</span>
<span class="sd">        boundary_unit : str, optional.</span>
<span class="sd">            Unit corresponding to [boundary_type].</span>
<span class="sd">            If ``boundary_type`` = &quot;waterlevel&quot;</span>
<span class="sd">                Allowed unit is [m]</span>
<span class="sd">            if &#39;&#39;boundary_type`` = &quot;discharge&quot;:</span>
<span class="sd">               Allowed unit is [m3/s]</span>
<span class="sd">            By default m.</span>
<span class="sd">        boundary_locs:</span>
<span class="sd">            Boundary locations to consider. One of [&quot;upstream&quot;, &quot;downstream&quot;, &quot;both&quot;].</span>
<span class="sd">            Only used for river waterlevel which can be upstream, downstream or both. By default &quot;downstream&quot;.</span>
<span class="sd">            For the others, it is automatically derived from branch_type and boundary_type.</span>
<span class="sd">        snap_offset : float, optional</span>
<span class="sd">                Snapping tolerance to automatically applying boundaries at the correct network nodes.</span>
<span class="sd">            By default 0.1, a small snapping is applied to avoid precision errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing 1D </span><span class="si">{</span><span class="n">boundary_type</span><span class="si">}</span><span class="s2"> boundaries for </span><span class="si">{</span><span class="n">branch_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">boundaries</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get_boundaries_with_nodeid</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">mesh_utils</span><span class="o">.</span><span class="n">network1d_nodes_geodataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">refdate</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_time</span><span class="p">()</span>  <span class="c1"># time slice</span>

        <span class="c1"># 1. get potential boundary locations based on branch_type and boundary_type</span>
        <span class="n">boundaries_branch_type</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">select_boundary_type</span><span class="p">(</span>
            <span class="n">boundaries</span><span class="p">,</span> <span class="n">branch_type</span><span class="p">,</span> <span class="n">boundary_type</span><span class="p">,</span> <span class="n">boundary_locs</span>
        <span class="p">)</span>

        <span class="c1"># 2. read boundary from user data</span>
        <span class="k">if</span> <span class="n">boundaries_geodataset_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">da_bnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataset</span><span class="p">(</span>
                <span class="n">boundaries_geodataset_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">boundaries</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span>
                    <span class="n">snap_offset</span>
                <span class="p">),</span>  <span class="c1"># only select data close to the boundary of the model region</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="n">boundary_type</span><span class="p">],</span>
                <span class="n">time_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">),</span>
                <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">(),</span>  <span class="c1"># assume model crs if none defined</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">boundary_type</span><span class="p">)</span>
            <span class="c1"># error if time mismatch</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_bnd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstart</span><span class="p">),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">da_bnd</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstop</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;forcing has different start and end time. Please check the forcing file. support yyyy-mm-dd HH:MM:SS. &quot;</span>
                <span class="p">)</span>
            <span class="c1"># reproject if needed and convert to location</span>
            <span class="k">if</span> <span class="n">da_bnd</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">da_bnd</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">boundaries_timeseries_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">da_bnd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 3. Derive DataArray with boundary values at boundary locations in boundaries_branch_type</span>
        <span class="n">da_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">compute_boundary_values</span><span class="p">(</span>
            <span class="n">boundaries</span><span class="o">=</span><span class="n">boundaries_branch_type</span><span class="p">,</span>
            <span class="n">da_bnd</span><span class="o">=</span><span class="n">da_bnd</span><span class="p">,</span>
            <span class="n">boundary_value</span><span class="o">=</span><span class="n">boundary_value</span><span class="p">,</span>
            <span class="n">boundary_type</span><span class="o">=</span><span class="n">boundary_type</span><span class="p">,</span>
            <span class="n">boundary_unit</span><span class="o">=</span><span class="n">boundary_unit</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4. set boundaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span>
            <span class="n">da_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;boundary1d_</span><span class="si">{</span><span class="n">da_out</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">branch_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>  <span class="c1"># FIXME: this format cannot be read back due to lack of branch type info from model files</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_bridges">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_bridges.html#hydromt_delft3dfm.DFlowFMModel.setup_bridges">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_bridges</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bridges_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bridges_defaults_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1D_bridges_defaults&quot;</span><span class="p">,</span>
        <span class="n">bridge_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares bridges, including bridge locations and bridge crossections.</span>

<span class="sd">        The bridges are read from ``bridges_fn`` and if any missing, filled with information provided in ``bridges_defaults_fn``.</span>

<span class="sd">        When reading ``bridges_fn``, only locations within the region will be read.</span>
<span class="sd">        Read locations are then filtered for value specified in ``bridge_filter`` on the column &quot;structure_type&quot; .</span>
<span class="sd">        Remaining locations are snapped to the existing network within a max distance defined in ``snap_offset`` and will be dropped if not snapped.</span>

<span class="sd">        A default rectangle bridge profile can be found in ``bridges_defaults_fn`` as an example.</span>

<span class="sd">        Structure attributes [&#39;structure_id&#39;, &#39;structure_type&#39;] are either taken from data or generated in the script.</span>
<span class="sd">        Structure attributes [&#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;, &#39;shift&#39;, &#39;length&#39;, &#39;pillarwidth&#39;, &#39;formfactor&#39;, &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>
<span class="sd">            are either taken from data,  or in case of missing read from defaults.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **bridges** geom: 1D bridges vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bridges_fn: str Path, optional</span>
<span class="sd">            Path or data source name for bridges, see data/data_sources.yml.</span>
<span class="sd">            Note only the points that are within the region polygon will be used.</span>

<span class="sd">            * Optional variables: [&#39;structure_id&#39;, &#39;structure_type&#39;, &#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;, &#39;shift&#39;, &#39;length&#39;, &#39;pillarwidth&#39;, &#39;formfactor&#39;, &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>

<span class="sd">        bridges_defaults_fn : str Path, optional</span>
<span class="sd">            Path to a csv file containing all defaults values per &quot;structure_type&quot;.</span>
<span class="sd">            By default `hydrolib.hydromt_delft3dfm.data.bridges.bridges_defaults.csv` is used. This file describes a minimum rectangle bridge profile.</span>

<span class="sd">            * Allowed variables: [&#39;structure_type&#39;, &#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;, &#39;shift&#39;, &#39;length&#39;, &#39;pillarwidth&#39;, &#39;formfactor&#39;, &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>

<span class="sd">        river_filter: str, optional</span>
<span class="sd">            Keyword in &quot;structure_type&quot; column of ``bridges_fn`` used to filter bridge features. If None all features are used (default).</span>

<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolenrance to automatically snap bridges to network and add [&#39;branchid&#39;, &#39;chainage&#39;] attributes.</span>
<span class="sd">            By default None. In this case, global variable &quot;network_snap_offset&quot; will be used..</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        dflowfm._setup_1dstructures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snap_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span> <span class="k">if</span> <span class="n">snap_offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">snap_offset</span>
        <span class="n">_st_type</span> <span class="o">=</span> <span class="s2">&quot;bridge&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chainage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;allowedflowdir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pillarwidth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;formfactor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;csdefid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shift&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inletlosscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outletlosscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;frictiontype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;friction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># read data</span>
        <span class="n">gdf_bridges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">bridges_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span>
        <span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">bridges_defaults_fn</span><span class="p">)</span>

        <span class="c1"># setup general 1d structures</span>
        <span class="n">bridges</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_1dstructures</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">gdf_bridges</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">bridge_filter</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">st_type</span><span class="o">=</span><span class="n">_st_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup crossection definitions</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">bridges</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bridges</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;crsdef&quot;</span><span class="p">)]]</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup bridges (note the allowed columns are different per structure)</span>
        <span class="n">bridges</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">bridges</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">bridges</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;structure_id&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_type&quot;</span><span class="p">:</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_branchid&quot;</span><span class="p">:</span> <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_chainage&quot;</span><span class="p">:</span> <span class="s2">&quot;chainage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;crsdef_id&quot;</span><span class="p">:</span> <span class="s2">&quot;csdefid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;friction_type&quot;</span><span class="p">:</span> <span class="s2">&quot;frictiontype&quot;</span><span class="p">,</span>
                <span class="s2">&quot;friction_value&quot;</span><span class="p">:</span> <span class="s2">&quot;friction&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># filter for allowed columns</span>
        <span class="n">allowed_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_allowed_columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bridges</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">allowed_columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">})</span>
        <span class="n">bridges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">bridges</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed_columns</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">bridges</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">bridges</span><span class="p">,</span> <span class="s2">&quot;bridges&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_culverts">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_culverts.html#hydromt_delft3dfm.DFlowFMModel.setup_culverts">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_culverts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">culverts_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">culverts_defaults_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1D_culverts_defaults&quot;</span><span class="p">,</span>
        <span class="n">culvert_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snap_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares culverts, including locations and crossections. Note that only subtype culvert is supported, i.e. inverted siphon is not supported.</span>

<span class="sd">        The culverts are read from ``culverts_fn`` and if any missing, filled with information provided in ``culverts_defaults_fn``.</span>

<span class="sd">        When reading ``culverts_fn``, only locations within the region will be read.</span>
<span class="sd">        Read locations are then filtered for value specified in ``culvert_filter`` on the column &quot;structure_type&quot; .</span>
<span class="sd">        Remaining locations are snapped to the existing network within a max distance defined in ``snap_offset`` and will be dropped if not snapped.</span>

<span class="sd">        A default ``culverts_defaults_fn`` that defines a circle culvert profile can be found in dflowfm.data.culverts as an example.</span>

<span class="sd">        Structure attributes [&#39;structure_id&#39;, &#39;structure_type&#39;] are either taken from data or generated in the script.</span>
<span class="sd">        Structure attributes [&#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;, &#39;leftlevel&#39;, &#39;rightlevel&#39;, &#39;length&#39;,</span>
<span class="sd">            &#39;valveonoff&#39;, &#39;valveopeningheight&#39;, &#39;numlosscoeff&#39;, &#39;relopening&#39;, &#39;losscoeff&#39;,</span>
<span class="sd">            &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>
<span class="sd">            are either taken from data,  or in case of missing read from defaults.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **culverts** geom: 1D culverts vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        culverts_fn: str Path, optional</span>
<span class="sd">            Path or data source name for culverts, see data/data_sources.yml.</span>
<span class="sd">            Note only the points that are within the region polygon will be used.</span>

<span class="sd">            * Optional variables: [&#39;structure_id&#39;, &#39;structure_type&#39;, &#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;,</span>
<span class="sd">                                    &#39;leftlevel&#39;, &#39;rightlevel&#39;, &#39;length&#39;, &#39;valveonoff&#39;, &#39;valveopeningheight&#39;,</span>
<span class="sd">                                    &#39;numlosscoeff&#39;, &#39;relopening&#39;, &#39;losscoeff&#39;,</span>
<span class="sd">                                    &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>

<span class="sd">        culverts_defaults_fn : str Path, optional</span>
<span class="sd">            Path to a csv file containing all defaults values per &quot;structure_type&quot;.</span>
<span class="sd">            By default `hydrolib.hydromt_delft3dfm.data.culverts.culverts_defaults.csv` is used.</span>
<span class="sd">            This file describes a default circle culvert profile.</span>

<span class="sd">            * Allowed variables: [&#39;structure_type&#39;, &#39;shape&#39;, &#39;diameter&#39;, &#39;width&#39;, &#39;t_width&#39;, &#39;height&#39;, &#39;closed&#39;,</span>
<span class="sd">                                    &#39;leftlevel&#39;, &#39;rightlevel&#39;, &#39;length&#39;, &#39;valveonoff&#39;, &#39;valveopeningheight&#39;,</span>
<span class="sd">                                    &#39;numlosscoeff&#39;, &#39;relopening&#39;, &#39;losscoeff&#39;,</span>
<span class="sd">                                    &#39;friction_type&#39;, &#39;friction_value&#39;, &#39;allowedflowdir&#39;,  &#39;inletlosscoeff&#39;, &#39;outletlosscoeff&#39;]</span>

<span class="sd">        culvert_filter: str, optional</span>
<span class="sd">            Keyword in &quot;structure_type&quot; column of ``culverts_fn`` used to filter culvert features. If None all features are used (default).</span>

<span class="sd">        snap_offset: float, optional</span>
<span class="sd">            Snapping tolenrance to automatically snap culverts to network and add [&#39;branchid&#39;, &#39;chainage&#39;] attributes.</span>
<span class="sd">            By default None. In this case, global variable &quot;network_snap_offset&quot; will be used..</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        dflowfm._setup_1dstructures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snap_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_snap_offset</span> <span class="k">if</span> <span class="n">snap_offset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">snap_offset</span>
        <span class="n">_st_type</span> <span class="o">=</span> <span class="s2">&quot;culvert&quot;</span>
        <span class="n">_allowed_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chainage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;allowedflowdir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;leftlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rightlevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;csdefid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inletlosscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outletlosscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;valveonoff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;valveopeningheight&quot;</span><span class="p">,</span>
            <span class="s2">&quot;numlosscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;relopening&quot;</span><span class="p">,</span>
            <span class="s2">&quot;losscoeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedfrictiontype&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bedfriction&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># read data</span>
        <span class="n">gdf_culverts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
            <span class="n">culverts_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span>
        <span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span><span class="n">culverts_defaults_fn</span><span class="p">)</span>

        <span class="c1"># setup general 1d structures</span>
        <span class="n">culverts</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">prepare_1dstructures</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
            <span class="n">gdf_culverts</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">defaults</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="n">culvert_filter</span><span class="p">,</span>
            <span class="n">snap_offset</span><span class="o">=</span><span class="n">snap_offset</span><span class="p">,</span>
            <span class="n">st_type</span><span class="o">=</span><span class="n">_st_type</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># setup crossection definitions</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">culverts</span><span class="p">[</span>
            <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">culverts</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;crsdef&quot;</span><span class="p">)]</span>
        <span class="p">]</span>
        <span class="n">crosssections</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">add_crosssections</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crosssections&quot;</span><span class="p">),</span> <span class="n">crosssections</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># setup culverts (note the allowed columns are different per structure)</span>
        <span class="n">culverts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">culverts</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">culverts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;structure_id&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_type&quot;</span><span class="p">:</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_branchid&quot;</span><span class="p">:</span> <span class="s2">&quot;branchid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;structure_chainage&quot;</span><span class="p">:</span> <span class="s2">&quot;chainage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;crsdef_id&quot;</span><span class="p">:</span> <span class="s2">&quot;csdefid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;friction_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bedfrictiontype&quot;</span><span class="p">,</span>
                <span class="s2">&quot;friction_value&quot;</span><span class="p">:</span> <span class="s2">&quot;bedfriction&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># filter for allowed columns</span>
        <span class="n">allowed_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_allowed_columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">culverts</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">allowed_columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">})</span>
        <span class="n">culverts</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">culverts</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed_columns</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">culverts</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">culverts</span><span class="p">,</span> <span class="s2">&quot;culverts&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_mesh2d">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_mesh2d.html#hydromt_delft3dfm.DFlowFMModel.setup_mesh2d">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_mesh2d</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">region</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xu</span><span class="o">.</span><span class="n">UgridDataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an 2D unstructured mesh or reads an existing 2D mesh according UGRID conventions.</span>

<span class="sd">        Grids are read according to UGRID conventions. An 2D unstructured mesh</span>
<span class="sd">        will be created as 2D rectangular grid from a geometry (geom_fn) or bbox.</span>
<span class="sd">        If an existing 2D mesh is given, then no new mesh will be generated but an extent</span>
<span class="sd">        can be extracted using the `bounds` argument of region.</span>

<span class="sd">        # Note that:</span>
<span class="sd">        # (1) Refinement of the mesh is a seperate setup function, however an existing grid with refinement (mesh_fn)</span>
<span class="sd">        # can already be read.</span>
<span class="sd">        # (2) If mesh also has 1D, 1D2Dlinks are created in a separate setup function.</span>
<span class="sd">        # (3) At mesh border, cells that intersect with geometry border will be kept.</span>
<span class="sd">        # (4) Only existing mesh with only 2D grid can be read. So 1D2D network files are not supported as mesh2d_fn.</span>

<span class="sd">        Adds/Updates model layers:</span>

<span class="sd">        * **grid_name** mesh topology: add grid_name 2D topology to mesh object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : dict</span>
<span class="sd">            Dictionary describing region of interest, bounds can be provided for type &#39;mesh&#39;.</span>
<span class="sd">        CRS for &#39;bbox&#39; and &#39;bounds&#39; should be 4326; e.g.:</span>

<span class="sd">            * {&#39;bbox&#39;: [xmin, ymin, xmax, ymax]}</span>

<span class="sd">            * {&#39;geom&#39;: &#39;path/to/polygon_geometry&#39;}</span>

<span class="sd">            * {&#39;mesh&#39;: &#39;path/to/2dmesh_file&#39;}</span>

<span class="sd">            * {&#39;mesh&#39;: &#39;path/to/2dmesh_file&#39;, &#39;bounds&#39;: [xmin, ymin, xmax, ymax]}</span>
<span class="sd">        res: float</span>
<span class="sd">            Resolution used to generate 2D mesh [unit of the CRS], required if region</span>
<span class="sd">            is not based on &#39;mesh&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mesh2d : xu.UgridDataset</span>
<span class="sd">            Generated mesh2d.</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Create the 2dmesh</span>
        <span class="n">mesh2d</span> <span class="o">=</span> <span class="n">create_mesh2d</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Add to self.mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># update res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="o">=</span> <span class="n">res</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_mesh2d_refine">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_mesh2d_refine.html#hydromt_delft3dfm.DFlowFMModel.setup_mesh2d_refine">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_mesh2d_refine</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">polygon_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refine the 2d mesh within the geometry based on polygon `polygon_fn` or raster samples `sample_fn`.</span>
<span class="sd">        The number of refinement is defined by `steps` if `polygon_fn` is used.</span>

<span class="sd">        Note that this function can only be applied on an existing regular rectangle 2d mesh.</span>
<span class="sd">        # FIXME: how to identify if the mesh is uniform rectangle 2d mesh? regular irregular?</span>

<span class="sd">        Adds/Updates model layers:</span>

<span class="sd">        * **2D mesh** geom: By any changes in 2D grid</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        polygon_fn : str Path, optional</span>
<span class="sd">            Path to a polygon or MultiPolygon used to refine the 2D mesh</span>
<span class="sd">        sample_fn  : str Path, optional</span>
<span class="sd">            Path to a raster sample file used to refine the 2D mesh.</span>
<span class="sd">            The value of each sample point is the number of steps to refine the mesh. Allow only single values.</span>
<span class="sd">            The resolution of the raster should be the same as the desired end result resolution.</span>

<span class="sd">            * Required variable: [&#39;steps&#39;]</span>
<span class="sd">        steps : int, optional</span>
<span class="sd">            Number of steps in the refinement when `polygon_fn&#39; is used.</span>
<span class="sd">            By default 1, i.e. no refinement is applied.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;mesh2d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;2d mesh is not available, use setup_mesh2d before refinement.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">polygon_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading geometry from file </span><span class="si">{</span><span class="n">polygon_fn</span><span class="si">}</span><span class="s2">. &quot;</span><span class="p">)</span>
            <span class="c1"># read</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">polygon_fn</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span>
            <span class="p">)</span>
            <span class="c1"># reproject</span>
            <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sample_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading samples from file </span><span class="si">{</span><span class="n">sample_fn</span><span class="si">}</span><span class="s2">. &quot;</span><span class="p">)</span>
            <span class="c1"># read</span>
            <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_rasterdataset</span><span class="p">(</span>
                <span class="n">sample_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                <span class="n">buffer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
                <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">],</span>
                <span class="n">single_var_as_array</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
            <span class="p">)</span>  <span class="c1"># float64 is needed by mesh kernel to convert into c double</span>
            <span class="c1"># reproject</span>
            <span class="k">if</span> <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Sample grid has a different resolution than model. Reprojecting with nearest but some information might be lost.&quot;</span>
                <span class="p">)</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

        <span class="c1"># refine</span>
        <span class="n">mesh2d</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">mesh2d_refine</span><span class="p">(</span>
            <span class="n">mesh2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mesh</span><span class="p">(</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">),</span>
            <span class="n">res</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_res</span><span class="p">,</span>
            <span class="n">gdf_polygon</span><span class="o">=</span><span class="n">gdf</span> <span class="k">if</span> <span class="n">polygon_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">da_sample</span><span class="o">=</span><span class="n">da</span> <span class="k">if</span> <span class="n">sample_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set mesh2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">,</span> <span class="n">overwrite_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># update res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="o">=</span> <span class="n">res</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_link1d2d">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_link1d2d.html#hydromt_delft3dfm.DFlowFMModel.setup_link1d2d">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_link1d2d</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">link_direction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1d_to_2d&quot;</span><span class="p">,</span>
        <span class="n">link_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;embedded&quot;</span><span class="p">,</span>
        <span class="n">polygon_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">branch_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="n">dist_factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate 1d2d links that link mesh1d and mesh2d according UGRID conventions.</span>

<span class="sd">        1d2d links are added to allow water exchange between 1d and 2d for a 1d2d model.</span>
<span class="sd">        They can only be added if both mesh1d and mesh2d are present. By default, 1d_to_2d links are generated for the entire mesh1d except boundary locations.</span>
<span class="sd">        When &#39;&#39;polygon_fn&#39;&#39; is specified, only links within the polygon will be added.</span>
<span class="sd">        When &#39;&#39;branch_type&#39;&#39; is specified, only 1d branches matching the specified type will be used for generating 1d2d link.</span>
<span class="sd">        # TODO: This option should also allows more customised setup for pipes and tunnels: 1d2d links will also be generated at boundary locations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        link_direction : str, optional</span>
<span class="sd">            Direction of the links: [&quot;1d_to_2d&quot;, &quot;2d_to_1d&quot;].</span>
<span class="sd">            Default to 1d_to_2d.</span>
<span class="sd">        link_type : str, optional</span>
<span class="sd">            Type of the links to be generated: [&quot;embedded&quot;, &quot;lateral&quot;]. only used when &#39;&#39;link_direction&#39;&#39; = &#39;2d_to_1d&#39;.</span>
<span class="sd">            Default to None.</span>
<span class="sd">        polygon_fn: str Path, optional</span>
<span class="sd">             Source name of raster data in data_catalog.</span>
<span class="sd">             Default to None.</span>
<span class="sd">        branch_type: str, Optional</span>
<span class="sd">             Type of branch to be used for 1d: [&quot;river&quot;,&quot;pipe&quot;,&quot;channel&quot;, &quot;tunnel&quot;].</span>
<span class="sd">             When &#39;&#39;branch_type&#39;&#39; = &quot;pipe&quot; or &quot;tunnel&quot; are specified, 1d2d links will also be generated at boundary locations.</span>
<span class="sd">             Default to None. Add 1d2d links for the all branches at non-boundary locations.</span>
<span class="sd">        max_length : Union[float, None], optional</span>
<span class="sd">             Max allowed edge length for generated links.</span>
<span class="sd">             Only used when &#39;&#39;link_direction&#39;&#39; = &#39;2d_to_1d&#39;  and &#39;&#39;link_type&#39;&#39; = &#39;lateral&#39;.</span>
<span class="sd">             Defaults to infinity.</span>
<span class="sd">        dist_factor : Union[float, None], optional:</span>
<span class="sd">             Factor to determine which links are kept.</span>
<span class="sd">             Only used when &#39;&#39;link_direction&#39;&#39; = &#39;2d_to_1d&#39;  and &#39;&#39;link_type&#39;&#39; = &#39;lateral&#39;.</span>
<span class="sd">             Defaults to 2.0. Links with an intersection distance larger than 2 times the center to edge distance of the cell, are removed.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">         workflows.links1d2d_add_links_1d_to_2d</span>
<span class="sd">         workflows.links1d2d_add_links_2d_to_1d_embedded</span>
<span class="sd">         workflows.links1d2d_add_links_2d_to_1d_lateral</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check existing network</span>
        <span class="k">if</span> <span class="s2">&quot;mesh1d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span> <span class="ow">or</span> <span class="s2">&quot;mesh2d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;cannot setup link1d2d: either mesh1d or mesh2d or both do not exist&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># if &quot;link1d2d&quot; in self.mesh_names:</span>
        <span class="c1">#     self.logger.warning(&quot;adding to existing link1d2d: link1d2d already exists&quot;)</span>
        <span class="c1">#    # FIXME: question - how to seperate if the user wants to update the entire 1d2d links object or simply wants to add another set of links? #1</span>
        <span class="c1">#    # TODO: would be nice in hydrolib to allow clear of subset of 1d2d links for specific branches</span>

        <span class="c1"># check input</span>
        <span class="k">if</span> <span class="n">polygon_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">within</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span><span class="n">polygon_fn</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding 1d2d links only within polygon </span><span class="si">{</span><span class="n">polygon_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">within</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">branch_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">branchids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">branchtype</span> <span class="o">==</span> <span class="n">branch_type</span>
            <span class="p">]</span><span class="o">.</span><span class="n">branchid</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>  <span class="c1"># use selective branches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding 1d2d links for </span><span class="si">{</span><span class="n">branch_type</span><span class="si">}</span><span class="s2"> branches.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">branchids</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># use all branches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;adding 1d2d links for all branches at non boundary locations.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># setup 1d2d links</span>
        <span class="k">if</span> <span class="n">link_direction</span> <span class="o">==</span> <span class="s2">&quot;1d_to_2d&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up 1d_to_2d links.&quot;</span><span class="p">)</span>
            <span class="c1"># recompute max_length based on the diagonal distance of the max mesh area</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_grids</span><span class="p">[</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">link1d2d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">links1d2d_add_links_1d_to_2d</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">branchids</span><span class="o">=</span><span class="n">branchids</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">within</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">link_direction</span> <span class="o">==</span> <span class="s2">&quot;2d_to_1d&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link_type</span> <span class="o">==</span> <span class="s2">&quot;embedded&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up 2d_to_1d embedded links.&quot;</span><span class="p">)</span>

                <span class="n">link1d2d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">links1d2d_add_links_2d_to_1d_embedded</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">branchids</span><span class="o">=</span><span class="n">branchids</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">within</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">link_type</span> <span class="o">==</span> <span class="s2">&quot;lateral&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;setting up 2d_to_1d lateral links.&quot;</span><span class="p">)</span>
                <span class="n">link1d2d</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">links1d2d_add_links_2d_to_1d_lateral</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                    <span class="n">branchids</span><span class="o">=</span><span class="n">branchids</span><span class="p">,</span>
                    <span class="n">within</span><span class="o">=</span><span class="n">within</span><span class="p">,</span>
                    <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span>
                    <span class="n">dist_factor</span><span class="o">=</span><span class="n">dist_factor</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;link_type </span><span class="si">{</span><span class="n">link_type</span><span class="si">}</span><span class="s2"> is not recognised.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;link_direction </span><span class="si">{</span><span class="n">link_direction</span><span class="si">}</span><span class="s2"> is not recognised.&quot;</span><span class="p">)</span>

        <span class="c1"># Add link1d2d to xu Ugrid mesh</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link1d2d</span><span class="p">[</span><span class="s2">&quot;link1d2d&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No 1d2d links were generated.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_link1d2d</span><span class="p">(</span><span class="n">link1d2d</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_maps_from_rasterdataset">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_maps_from_rasterdataset.html#hydromt_delft3dfm.DFlowFMModel.setup_maps_from_rasterdataset">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_maps_from_rasterdataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reproject_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="n">interpolation_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
        <span class="n">locationtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component adds data variable(s) from ``raster_fn`` to maps object.</span>

<span class="sd">        If raster is a dataset, all variables will be added unless ``variables`` list is specified.</span>

<span class="sd">        Adds model layers:</span>

<span class="sd">        * **raster.name** maps: data from raster_fn</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raster_fn: str</span>
<span class="sd">            Source name of raster data in data_catalog.</span>
<span class="sd">        variables: list, optional</span>
<span class="sd">            List of variables to add to maps from raster_fn. By default all.</span>
<span class="sd">            Available variables: [&#39;elevtn&#39;, &#39;waterlevel&#39;, &#39;waterdepth&#39;, &#39;pet&#39;, &#39;infiltcap&#39;, &#39;roughness_chezy&#39;, &#39;roughness_manning&#39;, &#39;roughness_walllawnikuradse&#39;, &#39;roughness_whitecolebrook&#39;]</span>
<span class="sd">        fill_method : str, optional</span>
<span class="sd">            If specified, fills no data values using fill_nodata method. Available methods</span>
<span class="sd">            are [&#39;linear&#39;, &#39;nearest&#39;, &#39;cubic&#39;, &#39;rio_idw&#39;].</span>
<span class="sd">        reproject_method : str, optional</span>
<span class="sd">            CRS reprojection method from rasterio.enums.Resampling. By default nearest.</span>
<span class="sd">            Available methods: [ &#39;nearest&#39;, &#39;bilinear&#39;, &#39;cubic&#39;, &#39;cubic_spline&#39;, &#39;lanczos&#39;, &#39;average&#39;, &#39;mode&#39;,</span>
<span class="sd">            &#39;gauss&#39;, &#39;max&#39;, &#39;min&#39;, &#39;med&#39;, &#39;q1&#39;, &#39;q3&#39;, &#39;sum&#39;, &#39;rms&#39;]</span>
<span class="sd">        interpolation_method : str, optional</span>
<span class="sd">            Interpolation method for DFlow-FM. By default triangulation. Except for waterlevel and</span>
<span class="sd">            waterdepth then the default is mean.</span>
<span class="sd">            When methods other than &#39;triangulation&#39;, the relative search cell size will be estimated based on resolution of the raster.</span>
<span class="sd">            Available methods: [&#39;triangulation&#39;, &#39;mean&#39;, &#39;nearestNb&#39;, &#39;max&#39;, &#39;min&#39;, &#39;invDist&#39;, &#39;minAbs&#39;, &#39;median&#39;]</span>
<span class="sd">        locationtype : str, optional</span>
<span class="sd">            LocationType in initial fields. Either 2d (default), 1d or all.</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Variable name, only in case data is of type DataArray or if a Dataset is added as is (split_dataset=False).</span>
<span class="sd">        split_dataset: bool, optional</span>
<span class="sd">            If data is a xarray.Dataset, either add it as is to maps or split it into several xarray.DataArrays.</span>
<span class="sd">            Default to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for name when split_dataset is False</span>
        <span class="k">if</span> <span class="n">split_dataset</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;name must be specified when split_dataset = False&quot;</span><span class="p">)</span>

        <span class="c1"># Call super method</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_maps_from_rasterdataset</span><span class="p">(</span>
            <span class="n">raster_fn</span><span class="o">=</span><span class="n">raster_fn</span><span class="p">,</span>
            <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
            <span class="n">fill_method</span><span class="o">=</span><span class="n">fill_method</span><span class="p">,</span>
            <span class="n">reproject_method</span><span class="o">=</span><span class="n">reproject_method</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">split_dataset</span><span class="o">=</span><span class="n">split_dataset</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">allowed_methods</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nearestNb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invDist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minAbs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">interpolation_method</span><span class="p">,</span> <span class="n">allowed_methods</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interpolation method </span><span class="si">{</span><span class="n">interpolation_method</span><span class="si">}</span><span class="s2"> not allowed. Select from </span><span class="si">{</span><span class="n">allowed_methods</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locationtype</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;2d&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Locationtype </span><span class="si">{</span><span class="n">locationtype</span><span class="si">}</span><span class="s2"> not allowed. Select from [&#39;2d&#39;, &#39;1d&#39;, &#39;all&#39;]&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_map_parameters_based_on_variable</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">locationtype</span><span class="p">,</span> <span class="n">interpolation_method</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_maps_from_raster_reclass">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_maps_from_raster_reclass.html#hydromt_delft3dfm.DFlowFMModel.setup_maps_from_raster_reclass">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_maps_from_raster_reclass</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raster_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reclass_table_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reclass_variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">fill_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reproject_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="n">interpolation_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
        <span class="n">locationtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">split_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This component adds data variable(s) to maps object by combining values in ``raster_mapping_fn`` to</span>
<span class="sd">        spatial layer ``raster_fn``. The ``mapping_variables`` rasters are first created by mapping variables values</span>
<span class="sd">        from ``raster_mapping_fn`` to value in the ``raster_fn`` grid.</span>

<span class="sd">        Adds model layers:</span>
<span class="sd">        * **mapping_variables** maps: data from raster_mapping_fn spatially ditributed with raster_fn</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raster_fn: str</span>
<span class="sd">            Source name of raster data in data_catalog. Should be a DataArray. Else use **kwargs to select</span>
<span class="sd">            variables/time_tuple in hydromt.data_catalog.get_rasterdataset method</span>
<span class="sd">        reclass_table_fn: str</span>
<span class="sd">            Source name of mapping table of raster_fn in data_catalog. Make sure the data type is consistant for a ``reclass_variables`` including nodata.</span>
<span class="sd">            For example, for roughness, it is common that the data type is float, then use no data value as -999.0.</span>
<span class="sd">        reclass_variables: list</span>
<span class="sd">            List of mapping_variables from raster_mapping_fn table to add to mesh. Index column should match values</span>
<span class="sd">            in raster_fn.</span>
<span class="sd">            Available variables: [&#39;elevtn&#39;, &#39;waterlevel&#39;, &#39;waterdepth&#39;, &#39;pet&#39;, &#39;infiltcap&#39;, &#39;roughness_chezy&#39;, &#39;roughness_manning&#39;, &#39;roughness_walllawnikuradse&#39;, &#39;roughness_whitecolebrook&#39;]</span>
<span class="sd">        fill_method : str, optional</span>
<span class="sd">            If specified, fills no data values using fill_nodata method. Available methods</span>
<span class="sd">            are {&#39;linear&#39;, &#39;nearest&#39;, &#39;cubic&#39;, &#39;rio_idw&#39;}.</span>
<span class="sd">        reproject_method : str, optional</span>
<span class="sd">            CRS reprojection method from rasterio.enums.Resampling. By default nearest.</span>
<span class="sd">            Available methods: [ &#39;nearest&#39;, &#39;bilinear&#39;, &#39;cubic&#39;, &#39;cubic_spline&#39;, &#39;lanczos&#39;, &#39;average&#39;, &#39;mode&#39;,</span>
<span class="sd">            &#39;gauss&#39;, &#39;max&#39;, &#39;min&#39;, &#39;med&#39;, &#39;q1&#39;, &#39;q3&#39;, &#39;sum&#39;, &#39;rms&#39;]</span>
<span class="sd">        interpolation_method : str, optional</span>
<span class="sd">            Interpolation method for DFlow-FM. By default triangulation. Except for waterlevel and waterdepth then</span>
<span class="sd">            the default is mean.</span>
<span class="sd">            When methods other than &#39;triangulation&#39;, the relative search cell size will be estimated based on resolution of the raster.</span>
<span class="sd">            Available methods: [&#39;triangulation&#39;, &#39;mean&#39;, &#39;nearestNb&#39;, &#39;max&#39;, &#39;min&#39;, &#39;invDist&#39;, &#39;minAbs&#39;, &#39;median&#39;]</span>
<span class="sd">        locationtype : str, optional</span>
<span class="sd">            LocationType in initial fields. Either 2d (default), 1d or all.</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Variable name, only in case data is of type DataArray or if a Dataset is added as is (split_dataset=False).</span>
<span class="sd">        split_dataset: bool, optional</span>
<span class="sd">            If data is a xarray.Dataset, either add it as is to maps or split it into several xarray.DataArrays.</span>
<span class="sd">            Default to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for name when split_dataset is False</span>
        <span class="k">if</span> <span class="n">split_dataset</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;name must be specified when split_dataset = False&quot;</span><span class="p">)</span>

        <span class="c1"># Call super method</span>
        <span class="n">reclass_variables</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_maps_from_raster_reclass</span><span class="p">(</span>
            <span class="n">raster_fn</span><span class="o">=</span><span class="n">raster_fn</span><span class="p">,</span>
            <span class="n">reclass_table_fn</span><span class="o">=</span><span class="n">reclass_table_fn</span><span class="p">,</span>
            <span class="n">reclass_variables</span><span class="o">=</span><span class="n">reclass_variables</span><span class="p">,</span>
            <span class="n">fill_method</span><span class="o">=</span><span class="n">fill_method</span><span class="p">,</span>
            <span class="n">reproject_method</span><span class="o">=</span><span class="n">reproject_method</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">split_dataset</span><span class="o">=</span><span class="n">split_dataset</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">allowed_methods</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;triangulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nearestNb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invDist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minAbs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">interpolation_method</span><span class="p">,</span> <span class="n">allowed_methods</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Interpolation method </span><span class="si">{</span><span class="n">interpolation_method</span><span class="si">}</span><span class="s2"> not allowed. Select from </span><span class="si">{</span><span class="n">allowed_methods</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">locationtype</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;2d&quot;</span><span class="p">,</span> <span class="s2">&quot;1d&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Locationtype </span><span class="si">{</span><span class="n">locationtype</span><span class="si">}</span><span class="s2"> not allowed. Select from [&#39;2d&#39;, &#39;1d&#39;, &#39;all&#39;]&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">reclass_variables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_map_parameters_based_on_variable</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">locationtype</span><span class="p">,</span> <span class="n">interpolation_method</span>
            <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__set_map_parameters_based_on_variable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">locationtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interpolation_method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set map parameters by updating user inputs to default self._MAP.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;locationtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locationtype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;interpolation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation_method</span>
            <span class="k">if</span> <span class="n">interpolation_method</span> <span class="o">!=</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">:</span>
                <span class="c1"># adjust relative search cell size for averaging methods</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">:</span>
                    <span class="n">relsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span>
                        <span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">relsize</span> <span class="o">=</span> <span class="mf">1.01</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s2">&quot;averagingrelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relsize</span>

<div class="viewcode-block" id="DFlowFMModel.setup_2dboundary">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_2dboundary.html#hydromt_delft3dfm.DFlowFMModel.setup_2dboundary">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_2dboundary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">boundaries_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundaries_timeseries_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundary_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">boundary_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;waterlevel&quot;</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the 2D boundaries from line geometries.</span>

<span class="sd">        The values can either be a spatially-uniform constant using ``boundaries_fn`` and ``boundary_value`` (default),</span>
<span class="sd">        or spatially-varying timeseries using ``boundaries_fn`` and  ``boundaries_timeseries_fn``</span>
<span class="sd">        The ``boundary_type`` can either be &quot;waterlevel&quot; or &quot;discharge&quot;.</span>

<span class="sd">        If ``boundaries_timeseries_fn`` has missing values, the constant ``boundary_value`` will be used.</span>

<span class="sd">        The dataset/timeseries are clipped to the model region (see below note), and model time based on the model config</span>
<span class="sd">        tstart and tstop entries.</span>

<span class="sd">        Note that:</span>
<span class="sd">        (1) Only line geometry that are contained within the distance of ``tolenrance`` to grid cells are allowed.</span>
<span class="sd">        (2) Because of the above, this function must be called before the mesh refinement. #FIXME: check this after deciding on mesh refinement being a workflow or function</span>
<span class="sd">        (3) when using constant boundary, the output forcing will be written to time series with constant values.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **boundary2d_{boundary_name}** forcing: 2D boundaries DataArray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        boundaries_fn: str Path</span>
<span class="sd">            Path or data source name for line geometry file.</span>
<span class="sd">            * Required variables if a combined time series data csv file: [&quot;boundary_id&quot;] with type int</span>
<span class="sd">        boundaries_timeseries_fn: str, Path</span>
<span class="sd">            Path to tabulated timeseries csv file with time index in first column</span>
<span class="sd">            and location index with type int in the first row, matching &quot;boundary_id&quot; in ``boundaries_fn`.</span>
<span class="sd">            see :py:meth:`hydromt.get_dataframe`, for details.</span>
<span class="sd">            NOTE: Require equidistant time series</span>
<span class="sd">        boundary_value : float, optional</span>
<span class="sd">            Constant value to use for all boundaries, and to</span>
<span class="sd">            fill in missing data. By default 0.0 m.</span>
<span class="sd">        boundary_type : str, optional</span>
<span class="sd">            Type of boundary tu use. One of [&quot;waterlevel&quot;, &quot;discharge&quot;].</span>
<span class="sd">            By default &quot;waterlevel&quot;.</span>
<span class="sd">        tolerance: float, optional</span>
<span class="sd">            Search tolerance factor between boundary polyline and grid cells.</span>
<span class="sd">            Unit: in cell size units (i.e., not meters)</span>
<span class="sd">            By default, 3.0</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            if &quot;boundary_id&quot; in &quot;boundaries_fn&quot; does not match the columns of ``boundaries_timeseries_fn``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing 2D boundaries.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;waterlevel&quot;</span><span class="p">:</span>
            <span class="n">boundary_unit</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
        <span class="k">if</span> <span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;discharge&quot;</span><span class="p">:</span>
            <span class="n">boundary_unit</span> <span class="o">=</span> <span class="s2">&quot;m3/s&quot;</span>

        <span class="n">_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_grids</span><span class="p">[</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">]</span>
        <span class="n">_mesh_region</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">_mesh</span><span class="o">.</span><span class="n">to_shapely</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">_mesh</span><span class="o">.</span><span class="n">face_dimension</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">unary_union</span>
        <span class="n">_boundary_region</span> <span class="o">=</span> <span class="n">_mesh_region</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">tolerance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
            <span class="n">_mesh_region</span>
        <span class="p">)</span>  <span class="c1"># region where 2d boundary is allowed</span>
        <span class="n">_boundary_region</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">_boundary_region</span><span class="p">]},</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="p">)</span>

        <span class="n">refdate</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_time</span><span class="p">()</span>  <span class="c1"># time slice</span>

        <span class="c1"># 1. read boundary geometries</span>
        <span class="k">if</span> <span class="n">boundaries_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gdf_bnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_geodataframe</span><span class="p">(</span>
                <span class="n">boundaries_fn</span><span class="p">,</span>
                <span class="n">geom</span><span class="o">=</span><span class="n">_boundary_region</span><span class="p">,</span>
                <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf_bnd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Boundaries are not found. Check if the boundary are outside of recognisable boundary region (cell size * tolerance to the mesh). &quot;</span>
                <span class="p">)</span>
            <span class="c1"># preprocess</span>
            <span class="n">gdf_bnd</span> <span class="o">=</span> <span class="n">gdf_bnd</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
            <span class="c1"># set index</span>
            <span class="k">if</span> <span class="s2">&quot;boundary_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf_bnd</span><span class="p">:</span>
                <span class="n">gdf_bnd</span><span class="p">[</span><span class="s2">&quot;boundary_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;2dboundary_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gdf_bnd</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gdf_bnd</span><span class="p">[</span><span class="s2">&quot;boundary_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_bnd</span><span class="p">[</span><span class="s2">&quot;boundary_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf_bnd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># 2. read timeseries boundaries</span>
        <span class="k">if</span> <span class="n">boundaries_timeseries_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading timeseries boundaries&quot;</span><span class="p">)</span>
            <span class="n">df_bnd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span>
                <span class="n">boundaries_timeseries_fn</span><span class="p">,</span> <span class="n">time_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># could not use open_geodataset due to line geometry</span>
            <span class="c1"># error if time mismatch or wrong parsing of dates</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">df_bnd</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Dates in boundaries_timeseries_fn were not parsed correctly. &quot;</span>
                    <span class="s2">&quot;Update the source kwargs in the DataCatalog based on the driver function arguments (eg pandas.read_csv for csv driver).&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">df_bnd</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_bnd</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Time in boundaries_timeseries_fn were shorter than model simulation time. &quot;</span>
                    <span class="s2">&quot;Update the source kwargs in the DataCatalog based on the driver function arguments (eg pandas.read_csv for csv driver).&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">gdf_bnd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># check if all boundary_id are in df_bnd</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">bnd</span> <span class="ow">in</span> <span class="n">df_bnd</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">bnd</span> <span class="ow">in</span> <span class="n">gdf_bnd</span><span class="p">[</span><span class="s2">&quot;boundary_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
                <span class="p">),</span> <span class="s2">&quot;Not all boundary_id are in df_bnd&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># default timeseries</span>
            <span class="n">d_bnd</span> <span class="o">=</span> <span class="p">{</span><span class="n">bnd_id</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">bnd_id</span> <span class="ow">in</span> <span class="n">gdf_bnd</span><span class="p">[</span><span class="s2">&quot;boundary_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>
            <span class="n">d_bnd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                        <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstart</span><span class="p">),</span>
                        <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstop</span><span class="p">),</span>
                        <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">df_bnd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d_bnd</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># 4. Derive DataArray with boundary values at boundary locations in boundaries_branch_type</span>
        <span class="n">da_out_dict</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">compute_2dboundary_values</span><span class="p">(</span>
            <span class="n">boundaries</span><span class="o">=</span><span class="n">gdf_bnd</span><span class="p">,</span>
            <span class="n">df_bnd</span><span class="o">=</span><span class="n">df_bnd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">boundary_value</span><span class="o">=</span><span class="n">boundary_value</span><span class="p">,</span>
            <span class="n">boundary_type</span><span class="o">=</span><span class="n">boundary_type</span><span class="p">,</span>
            <span class="n">boundary_unit</span><span class="o">=</span><span class="n">boundary_unit</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 5. set boundaries</span>
        <span class="k">for</span> <span class="n">da_out_name</span><span class="p">,</span> <span class="n">da_out</span> <span class="ow">in</span> <span class="n">da_out_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;boundary2d_</span><span class="si">{</span><span class="n">da_out_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># adjust parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.openboundarytolerance&quot;</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_rainfall_from_constant">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_rainfall_from_constant.html#hydromt_delft3dfm.DFlowFMModel.setup_rainfall_from_constant">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_rainfall_from_constant</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constant_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares constant daily rainfall_rate timeseries for the 2D grid based on ``constant_value``.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **meteo_{meteo_type}** forcing: DataArray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constant_value: float</span>
<span class="sd">            Constant value for the rainfall_rate timeseries in mm/day.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing rainfall meteo forcing from uniform timeseries.&quot;</span><span class="p">)</span>

        <span class="n">refdate</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_time</span><span class="p">()</span>  <span class="c1"># time slice</span>
        <span class="n">meteo_location</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># global station location</span>

        <span class="n">df_meteo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstart</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">tstop</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span>
                <span class="p">),</span>
                <span class="s2">&quot;precip&quot;</span><span class="p">:</span> <span class="n">constant_value</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># 3. Derive DataArray with meteo values</span>
        <span class="n">da_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">compute_meteo_forcings</span><span class="p">(</span>
            <span class="n">df_meteo</span><span class="o">=</span><span class="n">df_meteo</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">constant_value</span><span class="p">,</span>
            <span class="n">is_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">meteo_location</span><span class="o">=</span><span class="n">meteo_location</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4. set meteo forcing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;meteo_</span><span class="si">{</span><span class="n">da_out</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 5. set meteo in mdu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;external_forcing.rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.setup_rainfall_from_uniform_timeseries">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.setup_rainfall_from_uniform_timeseries.html#hydromt_delft3dfm.DFlowFMModel.setup_rainfall_from_uniform_timeseries">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_rainfall_from_uniform_timeseries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">meteo_timeseries_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">fill_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">is_rate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares spatially uniform rainfall forcings to 2d grid using timeseries from ``meteo_timeseries_fn``.</span>
<span class="sd">        For now only support global  (spatially uniform) timeseries.</span>

<span class="sd">        If ``meteo_timeseries_fn`` has missing values or shorter than model simulation time, the constant ``fill_value`` will be used, e.g. 0.</span>

<span class="sd">        The dataset/timeseries are clipped to the model time based on the model config</span>
<span class="sd">        tstart and tstop entries.</span>

<span class="sd">        Adds/Updates model layers:</span>
<span class="sd">            * **meteo_{meteo_type}** forcing: DataArray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meteo_timeseries_fn: str, Path</span>
<span class="sd">            Path or data source name to tabulated timeseries csv file with time index in first column.</span>

<span class="sd">            * Required variables : [&#39;precip&#39;]</span>

<span class="sd">            see :py:meth:`hydromt.get_dataframe`, for details.</span>
<span class="sd">            NOTE:</span>
<span class="sd">            Require equidistant time series</span>
<span class="sd">            If ``is_rate`` = True, unit is expected to be in mm/day and else mm.</span>
<span class="sd">        fill_value : float, optional</span>
<span class="sd">            Constant value to use to fill in missing data. By default 0.</span>
<span class="sd">        is_rate : bool, optional</span>
<span class="sd">            Specify if the type of meteo data is direct &quot;rainfall&quot; (False) or &quot;rainfall_rate&quot; (True).</span>
<span class="sd">            By default True for &quot;rainfall_rate&quot;. Note that Delft3DFM 1D2D Suite 2022.04 supports only &quot;rainfall_rate&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing rainfall meteo forcing from uniform timeseries.&quot;</span><span class="p">)</span>

        <span class="n">refdate</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_time</span><span class="p">()</span>  <span class="c1"># time slice</span>
        <span class="n">meteo_location</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># global station location</span>

        <span class="c1"># get meteo timeseries</span>
        <span class="n">df_meteo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_catalog</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(</span>
            <span class="n">meteo_timeseries_fn</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">],</span> <span class="n">time_tuple</span><span class="o">=</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># error if time mismatch or wrong parsing of dates</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Dates in meteo_timeseries_fn were not parsed correctly. &quot;</span>
                <span class="s2">&quot;Update the source kwargs in the DataCatalog based on the driver function arguments (eg pandas.read_csv for csv driver).&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Time in meteo_timeseries_fn were shorter than model simulation time. &quot;</span>
                <span class="s2">&quot;Will fill in using fill_value.&quot;</span>
            <span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">t_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">dt</span><span class="p">))</span>
            <span class="n">df_meteo</span> <span class="o">=</span> <span class="n">df_meteo</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="n">df_meteo</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_meteo</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># 3. Derive DataArray with meteo values</span>
        <span class="n">da_out</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">compute_meteo_forcings</span><span class="p">(</span>
            <span class="n">df_meteo</span><span class="o">=</span><span class="n">df_meteo</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="n">is_rate</span><span class="o">=</span><span class="n">is_rate</span><span class="p">,</span>
            <span class="n">meteo_location</span><span class="o">=</span><span class="n">meteo_location</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4. set meteo forcing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;meteo_</span><span class="si">{</span><span class="n">da_out</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 5. set meteo in mdu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;external_forcing.rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


    <span class="c1"># ## I/O</span>
<div class="viewcode-block" id="DFlowFMModel.read">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read.html#hydromt_delft3dfm.DFlowFMModel.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to read the complete model schematization and configuration from file.</span>
<span class="sd">        # FIXME: where to read crs?.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading model data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_dimr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_maps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_geoms</span><span class="p">()</span>  <span class="c1"># needs mesh so should be done after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_forcing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_crs</span><span class="p">()</span></div>


<div class="viewcode-block" id="DFlowFMModel.write">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write.html#hydromt_delft3dfm.DFlowFMModel.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># complete model</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to write the complete model schematization and configuration to file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing model data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># if in r, r+ mode, only write updated components</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot write in read-only mode&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_maps</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_geoms</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_mesh</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forcing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_forcing</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>  <span class="c1"># dflowfm config, should always be last!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimr</span><span class="p">:</span>  <span class="c1"># dimr config, should always be last after dflowfm config!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_dimr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_data_catalog</span><span class="p">()</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_config">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_config.html#hydromt_delft3dfm.DFlowFMModel.read_config">[docs]</a>
    <span class="k">def</span> <span class="nf">read_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use Hydrolib-core reader and return to dictionnary.&quot;&quot;&quot;</span>
        <span class="c1"># Read via init_dfmmodel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_dfmmodel</span><span class="p">()</span>
        <span class="c1"># Convert to full dictionnary without hydrolib-core objects</span>
        <span class="n">cf_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;filepath&quot;</span><span class="p">:</span>
                <span class="n">cf_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ci_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ki</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ki</span> <span class="o">==</span> <span class="s2">&quot;frictfile&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># list of filepath</span>
                        <span class="n">ci_dict</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">vj</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">for</span> <span class="n">vj</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">ki</span> <span class="o">!=</span> <span class="s2">&quot;comments&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="s2">&quot;filepath&quot;</span><span class="p">):</span>
                            <span class="c1"># need to change the filepath object to path</span>
                            <span class="n">ci_dict</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">=</span> <span class="n">vi</span><span class="o">.</span><span class="n">filepath</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ci_dict</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">=</span> <span class="n">vi</span>
                <span class="n">cf_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ci_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">cf_dict</span></div>


<div class="viewcode-block" id="DFlowFMModel.write_config">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_config.html#hydromt_delft3dfm.DFlowFMModel.write_config">[docs]</a>
    <span class="k">def</span> <span class="nf">write_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;From config dict to Hydrolib MDU.&quot;&quot;&quot;</span>
        <span class="c1"># Not sure if this is worth it compared to just calling write_config super method</span>
        <span class="c1"># advantage is the validator but the whole model is then read when initialising FMModel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>

        <span class="n">cf_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Need to switch to dflowfm folder for files to be found and properly added</span>
        <span class="n">mdu_fn</span> <span class="o">=</span> <span class="n">cf_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filepath&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mdu_fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">mdu_fn</span><span class="p">))</span>
        <span class="n">mdu</span> <span class="o">=</span> <span class="n">FMModel</span><span class="p">(</span><span class="o">**</span><span class="n">cf_dict</span><span class="p">)</span>
        <span class="c1"># add filepath</span>
        <span class="n">mdu</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">mdu_fn</span>
        <span class="c1"># write</span>
        <span class="n">mdu</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Go back to working dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_maps">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_maps.html#hydromt_delft3dfm.DFlowFMModel.read_maps">[docs]</a>
    <span class="k">def</span> <span class="nf">read_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read maps from initialfield and parse to dict of xr.DataArray.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_read_mode</span><span class="p">()</span>
        <span class="c1"># Read initial fields</span>
        <span class="n">inifield_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">inifieldfile</span>
        <span class="k">if</span> <span class="n">inifield_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Loop over initial / parameter to read the geotif</span>
            <span class="n">inilist</span> <span class="o">=</span> <span class="n">inifield_model</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">inilist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inifield_model</span><span class="o">.</span><span class="n">parameter</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inilist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># DFM map names</span>
                <span class="n">rm_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">:</span>
                    <span class="n">rm_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">inidict</span> <span class="ow">in</span> <span class="n">inilist</span><span class="p">:</span>
                    <span class="n">_fn</span> <span class="o">=</span> <span class="n">inidict</span><span class="o">.</span><span class="n">datafile</span><span class="o">.</span><span class="n">filepath</span>
                    <span class="c1"># Bug: when initialising IniFieldModel hydrolib-core does not parse correclty the relative path</span>
                    <span class="c1"># For now re-update manually....</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">_fn</span><span class="p">):</span>
                        <span class="n">_fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;maps&quot;</span><span class="p">,</span> <span class="n">_fn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">inimap</span> <span class="o">=</span> <span class="n">hydromt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">open_raster</span><span class="p">(</span><span class="n">_fn</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">inidict</span><span class="o">.</span><span class="n">quantity</span>
                    <span class="c1"># Need to get branchid from config</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;frictioncoefficient&quot;</span><span class="p">:</span>
                        <span class="n">frictype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;physics.uniffricttype&quot;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">fricname</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">n</span>
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frictype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">frictype</span>
                        <span class="p">]</span>
                        <span class="n">rm_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fricname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Check if name in self._MAPS to update properties</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rm_dict</span><span class="p">:</span>
                        <span class="c1"># update all keywords</span>
                        <span class="k">if</span> <span class="s2">&quot;comments&quot;</span> <span class="ow">in</span> <span class="n">inidict</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                            <span class="n">inidict</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">rm_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inidict</span><span class="p">)</span>
                        <span class="c1"># Update default interpolation method</span>
                        <span class="k">if</span> <span class="n">inidict</span><span class="o">.</span><span class="n">interpolationmethod</span> <span class="o">==</span> <span class="s2">&quot;averaging&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">rm_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span>
                                <span class="s2">&quot;interpolation&quot;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">inidict</span><span class="o">.</span><span class="n">averagingtype</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">rm_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span>
                                <span class="s2">&quot;interpolation&quot;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">inidict</span><span class="o">.</span><span class="n">interpolationmethod</span>
                        <span class="c1"># Rename to hydromt name</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">rm_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="c1"># Add to maps</span>
                    <span class="n">inimap</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_maps</span><span class="p">(</span><span class="n">inimap</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.write_maps">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_maps.html#hydromt_delft3dfm.DFlowFMModel.write_maps">[docs]</a>
    <span class="k">def</span> <span class="nf">write_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write maps as tif files in maps folder and update initial fields.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No maps data found, skip writing.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>
        <span class="c1"># Global parameters</span>
        <span class="n">mapsroot</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;maps&quot;</span><span class="p">)</span>
        <span class="n">inilist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">paramlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing maps files to </span><span class="si">{</span><span class="n">mapsroot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_prepare_inifields</span><span class="p">(</span><span class="n">da_dict</span><span class="p">,</span> <span class="n">da</span><span class="p">):</span>
            <span class="c1"># Write tif files</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="s2">&quot;initype&quot;</span><span class="p">]</span>
            <span class="n">interp_method</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="s2">&quot;interpolation&quot;</span><span class="p">]</span>
            <span class="n">locationtype</span> <span class="o">=</span> <span class="n">da_dict</span><span class="p">[</span><span class="s2">&quot;locationtype&quot;</span><span class="p">]</span>
            <span class="n">_fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">mapsroot</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">nodata</span><span class="p">):</span>
                <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
            <span class="n">da</span><span class="o">.</span><span class="n">raster</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">_fn</span><span class="p">)</span>
            <span class="c1"># Prepare dict</span>
            <span class="k">if</span> <span class="n">interp_method</span> <span class="o">==</span> <span class="s2">&quot;triangulation&quot;</span><span class="p">:</span>
                <span class="n">inidict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;dataFile&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../maps/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dataFileType&quot;</span><span class="p">:</span> <span class="s2">&quot;GeoTIFF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;interpolationMethod&quot;</span><span class="p">:</span> <span class="n">interp_method</span><span class="p">,</span>
                    <span class="s2">&quot;operand&quot;</span><span class="p">:</span> <span class="n">da_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oprand&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;locationType&quot;</span><span class="p">:</span> <span class="n">locationtype</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inidict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;dataFile&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;../maps/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dataFileType&quot;</span><span class="p">:</span> <span class="s2">&quot;GeoTIFF&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;interpolationMethod&quot;</span><span class="p">:</span> <span class="s2">&quot;averaging&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operand&quot;</span><span class="p">:</span> <span class="n">da_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oprand&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;averagingType&quot;</span><span class="p">:</span> <span class="n">interp_method</span><span class="p">,</span>
                    <span class="s2">&quot;averagingRelSize&quot;</span><span class="p">:</span> <span class="n">da_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;averagingrelsize&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;locationType&quot;</span><span class="p">:</span> <span class="n">locationtype</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;initial&quot;</span><span class="p">:</span>
                <span class="n">inilist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inidict</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span>
                <span class="n">paramlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inidict</span><span class="p">)</span>

        <span class="c1"># Only write maps that are listed in self._MAPS, rename tif on the fly</span>
        <span class="c1"># TODO raise value error if both waterdepth and waterlevel are given as maps.items</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">:</span>
                    <span class="n">_prepare_inifields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">ds</span><span class="p">)</span>
                    <span class="c1"># update config if friction</span>
                    <span class="k">if</span> <span class="s2">&quot;frictype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span>
                            <span class="s2">&quot;physics.UniFrictType&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;frictype&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># update config if infiltration</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;infiltcap&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;grw.infiltrationmodel&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">:</span>
                        <span class="n">_prepare_inifields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                        <span class="c1"># update config if frcition</span>
                        <span class="k">if</span> <span class="s2">&quot;frictype&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span>
                                <span class="s2">&quot;physics.UniFrictType&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MAPS</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;frictype&quot;</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="c1"># update config if infiltration</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;infiltcap&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;grw.infiltrationmodel&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Assign initial fields to model and write</span>
        <span class="n">inifield_model</span> <span class="o">=</span> <span class="n">IniFieldModel</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">inilist</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="n">paramlist</span><span class="p">)</span>
        <span class="c1"># Bug: when initialising IniFieldModel hydrolib-core does not parse correclty the relative path</span>
        <span class="c1"># For now re-update manually....</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inifield_model</span><span class="o">.</span><span class="n">initial</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;../maps/</span><span class="si">{</span><span class="n">inifield_model</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datafile</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">inifield_model</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datafile</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inifield_model</span><span class="o">.</span><span class="n">parameter</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;../maps/</span><span class="si">{</span><span class="n">inifield_model</span><span class="o">.</span><span class="n">parameter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datafile</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">inifield_model</span><span class="o">.</span><span class="n">parameter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datafile</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">path</span>
        <span class="c1"># Write inifield file</span>
        <span class="n">inifield_model_filename</span> <span class="o">=</span> <span class="n">inifield_model</span><span class="o">.</span><span class="n">_filename</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.ini&quot;</span>
        <span class="n">fm_dir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>
        <span class="n">inifield_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">fm_dir</span><span class="p">,</span> <span class="n">inifield_model_filename</span><span class="p">),</span>
            <span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># save filepath in the config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.inifieldfile&quot;</span><span class="p">,</span> <span class="n">inifield_model_filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_geoms">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_geoms.html#hydromt_delft3dfm.DFlowFMModel.read_geoms">[docs]</a>
    <span class="k">def</span> <span class="nf">read_geoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># FIXME: gives an error when only 2D model.</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read model geometries files at &lt;root&gt;/&lt;geoms&gt; and add to geoms property.</span>

<span class="sd">        For branches / boundaries etc... the reading of hydrolib-core objects happens in read_mesh</span>
<span class="sd">        There the geoms geojson copies are re-set based on dflowfm files content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_read_mode</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read_geoms</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="s2">&quot;geoms/region.geojson&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">crosslocfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Read cross-sections and friction</span>
            <span class="c1"># Add crosssections properties, should be done before friction</span>
            <span class="c1"># Branches are needed do derive locations, self.branches should start the read if not done yet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading cross-sections files&quot;</span><span class="p">)</span>
            <span class="n">crosssections</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_crosssections</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">)</span>

            <span class="c1"># Add friction properties from roughness files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading friction files&quot;</span><span class="p">)</span>
            <span class="n">crosssections</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_friction</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">crosssections</span><span class="p">,</span> <span class="s2">&quot;crosssections&quot;</span><span class="p">)</span>

        <span class="c1"># Read manholes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">storagenodefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading manholes file&quot;</span><span class="p">)</span>
            <span class="n">network1d_nodes</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">network1d_nodes_geodataframe</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">manholes</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_manholes</span><span class="p">(</span><span class="n">network1d_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">manholes</span><span class="p">,</span> <span class="s2">&quot;manholes&quot;</span><span class="p">)</span>

        <span class="c1"># Read structures</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">structurefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading structures file&quot;</span><span class="p">)</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_structures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">st_type</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">structures</span><span class="p">[</span><span class="n">structures</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">st_type</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st_type</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.write_geoms">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_geoms.html#hydromt_delft3dfm.DFlowFMModel.write_geoms">[docs]</a>
    <span class="k">def</span> <span class="nf">write_geoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_mesh_gdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write model geometries to a GeoJSON file at &lt;root&gt;/&lt;geoms&gt;.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>

        <span class="c1"># Optional: also write mesh_gdf object</span>
        <span class="k">if</span> <span class="n">write_mesh_gdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_gdf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Write geojson equivalent of all objects. Note that these files are not directly used when updating the model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_geoms</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="s2">&quot;geoms/</span><span class="si">{name}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>

        <span class="c1"># Write dfm files</span>
        <span class="n">savedir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>

        <span class="c1"># Write cross-sections (inc. friction)</span>
        <span class="k">if</span> <span class="s2">&quot;crosssections&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geoms</span><span class="p">:</span>
            <span class="c1"># Crosssections</span>
            <span class="n">gdf_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;crosssections&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting cross-sections files crsdef and crsloc&quot;</span><span class="p">)</span>
            <span class="n">crsdef_fn</span><span class="p">,</span> <span class="n">crsloc_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">write_crosssections</span><span class="p">(</span><span class="n">gdf_crs</span><span class="p">,</span> <span class="n">savedir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.crossdeffile&quot;</span><span class="p">,</span> <span class="n">crsdef_fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.crosslocfile&quot;</span><span class="p">,</span> <span class="n">crsloc_fn</span><span class="p">)</span>

            <span class="c1"># Friction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting friction file(s)&quot;</span><span class="p">)</span>
            <span class="n">friction_fns</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">write_friction</span><span class="p">(</span><span class="n">gdf_crs</span><span class="p">,</span> <span class="n">savedir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.frictfile&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">friction_fns</span><span class="p">))</span>

        <span class="c1"># Write structures</span>
        <span class="c1"># Manholes</span>
        <span class="k">if</span> <span class="s2">&quot;manholes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting manholes file.&quot;</span><span class="p">)</span>
            <span class="n">storage_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">write_manholes</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;manholes&quot;</span><span class="p">],</span>
                <span class="n">savedir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.storagenodefile&quot;</span><span class="p">,</span> <span class="n">storage_fn</span><span class="p">)</span>

        <span class="c1"># Write structures</span>
        <span class="n">existing_structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bridges&quot;</span><span class="p">,</span> <span class="s2">&quot;culverts&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_structures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># combine all structures</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">existing_structures</span><span class="p">:</span>
                <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">))</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">structures</span><span class="p">))</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># write</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting structures file.&quot;</span><span class="p">)</span>
            <span class="n">structures_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">write_structures</span><span class="p">(</span>
                <span class="n">structures</span><span class="p">,</span>
                <span class="n">savedir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.structurefile&quot;</span><span class="p">,</span> <span class="n">structures_fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_forcing">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_forcing.html#hydromt_delft3dfm.DFlowFMModel.read_forcing">[docs]</a>
    <span class="k">def</span> <span class="nf">read_forcing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># FIXME reading of forcing should include boundary, lateral and meteo</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read forcing at &lt;root/?/&gt; and parse to dict of xr.DataArray.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_read_mode</span><span class="p">()</span>
        <span class="c1"># Read external forcing</span>
        <span class="n">ext_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">external_forcing</span><span class="o">.</span><span class="n">extforcefilenew</span>
        <span class="k">if</span> <span class="n">ext_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># boundary</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_model</span><span class="o">.</span><span class="n">boundary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_ext</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ext_model</span><span class="o">.</span><span class="n">boundary</span><span class="p">])</span>
                <span class="c1"># 1d boundary</span>
                <span class="n">df_ext_1d</span> <span class="o">=</span> <span class="n">df_ext</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_ext</span><span class="o">.</span><span class="n">nodeid</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_ext_1d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Forcing data arrays to prepare for each quantity</span>
                    <span class="n">forcing_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ext_1d</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="c1"># Loop over forcing names to build data arrays</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">forcing_names</span><span class="p">:</span>
                        <span class="c1"># Get the dataframe corresponding to the current variable</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df_ext_1d</span><span class="p">[</span><span class="n">df_ext_1d</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
                        <span class="c1"># Get the corresponding nodes gdf</span>
                        <span class="n">network1d_nodes</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">network1d_nodes_geodataframe</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">node_geoms</span> <span class="o">=</span> <span class="n">network1d_nodes</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">network1d_nodes</span><span class="p">[</span><span class="s2">&quot;nodeid&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">nodeid</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="n">da_out</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_1dboundary</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">node_geoms</span>
                        <span class="p">)</span>
                        <span class="c1"># Add to forcing</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">)</span>
                <span class="c1"># 2d boundary</span>
                <span class="n">df_ext_2d</span> <span class="o">=</span> <span class="n">df_ext</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_ext</span><span class="o">.</span><span class="n">nodeid</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_ext_2d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_ext_2d</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">da_out</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_2dboundary</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">parent</span>
                        <span class="p">)</span>
                        <span class="c1"># Add to forcing</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">)</span>
            <span class="c1"># meteo</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext_model</span><span class="o">.</span><span class="n">meteo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df_ext</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ext_model</span><span class="o">.</span><span class="n">meteo</span><span class="p">])</span>
                <span class="c1"># Forcing dataarrays to prepare for each quantity</span>
                <span class="n">forcing_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_ext</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="c1"># Loop over forcing names to build data arrays</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">forcing_names</span><span class="p">:</span>
                    <span class="c1"># Get the dataframe corresponding to the current variable</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df_ext</span><span class="p">[</span><span class="n">df_ext</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
                    <span class="n">da_out</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_meteo</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="c1"># Add to forcing</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_forcing</span><span class="p">(</span><span class="n">da_out</span><span class="p">)</span></div>

            <span class="c1"># TODO lateral</span>

<div class="viewcode-block" id="DFlowFMModel.write_forcing">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_forcing.html#hydromt_delft3dfm.DFlowFMModel.write_forcing">[docs]</a>
    <span class="k">def</span> <span class="nf">write_forcing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write forcing into hydrolib-core ext and forcing models.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_forcing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No forcing data found, skip writing.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting forcing files.&quot;</span><span class="p">)</span>
            <span class="n">savedir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>
            <span class="c1"># create new external forcing file</span>
            <span class="n">ext_fn</span> <span class="o">=</span> <span class="s2">&quot;bnd.ext&quot;</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">ext_fn</span><span class="p">))</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># populate external forcing file</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">write_1dboundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">ext_fn</span><span class="o">=</span><span class="n">ext_fn</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">write_2dboundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">ext_fn</span><span class="o">=</span><span class="n">ext_fn</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">write_meteo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing</span><span class="p">,</span> <span class="n">savedir</span><span class="p">,</span> <span class="n">ext_fn</span><span class="o">=</span><span class="n">ext_fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;external_forcing.extforcefilenew&quot;</span><span class="p">,</span> <span class="n">ext_fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_mesh">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_mesh.html#hydromt_delft3dfm.DFlowFMModel.read_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">read_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read network file with Hydrolib-core and extract mesh/branches info.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_read_mode</span><span class="p">()</span>

        <span class="c1"># Read mesh</span>
        <span class="c1"># hydrolib-core convention</span>
        <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">netfile</span><span class="o">.</span><span class="n">network</span>
        <span class="c1"># FIXME: crs info is not available in dfmmodel, so get it from region.geojson</span>
        <span class="c1"># Cannot use read_geoms yet because for some some geoms (crosssections, manholes) mesh needs to be read first...</span>
        <span class="n">region_fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;geoms&quot;</span><span class="p">,</span> <span class="s2">&quot;region.geojson&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">region_fn</span><span class="p">):</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">region_fn</span><span class="p">)</span><span class="o">.</span><span class="n">crs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># convert to xugrid</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">mesh_from_hydrolib_network</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
        <span class="c1"># set mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="n">mesh</span>

        <span class="c1"># update resolution</span>
        <span class="k">if</span> <span class="s2">&quot;mesh2d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh_grids</span><span class="p">[</span><span class="s2">&quot;mesh2d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">node_x</span><span class="p">))</span>

        <span class="c1"># creates branches geometry from network1d</span>
        <span class="k">if</span> <span class="s2">&quot;network1d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="n">network1d_geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_gdf</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
            <span class="n">network1d_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
            <span class="c1"># Create the branches GeoDataFrame</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="n">network1d_geometry</span>
            <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;branchid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network1d_dataset</span><span class="p">[</span><span class="s2">&quot;network1d_branch_id&quot;</span><span class="p">]</span>
            <span class="n">branches</span><span class="p">[</span><span class="s2">&quot;branchorder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network1d_dataset</span><span class="p">[</span><span class="s2">&quot;network1d_branch_order&quot;</span><span class="p">]</span>
            <span class="c1"># branches[&quot;branchtype&quot;] = network1d_dataset[&quot;network1d_branch_type&quot;] # might support in the future https://github.com/Deltares/HYDROLIB-core/issues/561</span>

            <span class="c1"># Add branchtype, properties from branches.gui file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading branches GUI file&quot;</span><span class="p">)</span>
            <span class="n">branches</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_branches_gui</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">)</span>

            <span class="c1"># Set branches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="o">=</span> <span class="n">branches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="s2">&quot;branches&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.write_mesh">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_mesh.html#hydromt_delft3dfm.DFlowFMModel.write_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">write_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write 1D branches and 2D mesh at &lt;root/dflowfm/fm_net.nc&gt; in model ready format.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>
        <span class="n">savedir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>
        <span class="n">mesh_filename</span> <span class="o">=</span> <span class="s2">&quot;fm_net.nc&quot;</span>

        <span class="c1"># write mesh</span>
        <span class="c1"># hydromt convention - FIXME hydrolib does not seem to read the 1D and links part of the mesh</span>
        <span class="c1"># super().write_mesh(fn=join(savedir, mesh_filename))</span>

        <span class="c1"># write with hydrolib-core</span>
        <span class="c1"># Note: hydrolib-core writes more information including attributes and converts some variables using start_index</span>
        <span class="c1"># FIXME: does not write crs that is recongnised by Delft3D FM GUI. check https://github.com/Deltares/dfm_tools/blob/main/dfm_tools/meshkernel_helpers.py#L82</span>

        <span class="n">network</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">hydrolib_network_from_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">network</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">savedir</span><span class="p">,</span> <span class="n">mesh_filename</span><span class="p">)))</span>

        <span class="c1"># save relative path to mdu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="s2">&quot;geometry.netfile&quot;</span><span class="p">,</span> <span class="n">mesh_filename</span><span class="p">)</span>

        <span class="c1"># other mesh1d related geometry TODO update</span>
        <span class="k">if</span> <span class="s2">&quot;mesh1d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span> <span class="ow">and</span> <span class="n">write_gui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writting branches.gui file&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;manholes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">write_branches_gui</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span> <span class="n">savedir</span><span class="p">)</span></div>


<div class="viewcode-block" id="DFlowFMModel.read_states">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_states.html#hydromt_delft3dfm.DFlowFMModel.read_states">[docs]</a>
    <span class="k">def</span> <span class="nf">read_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read states at &lt;root/?/&gt; and parse to dict of xr.DataArray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_states</span></div>

        <span class="c1"># raise NotImplementedError()</span>

<div class="viewcode-block" id="DFlowFMModel.write_states">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_states.html#hydromt_delft3dfm.DFlowFMModel.write_states">[docs]</a>
    <span class="k">def</span> <span class="nf">write_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write states at &lt;root/?/&gt; in model ready format.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

        <span class="c1"># raise NotImplementedError()</span>

<div class="viewcode-block" id="DFlowFMModel.read_results">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_results.html#hydromt_delft3dfm.DFlowFMModel.read_results">[docs]</a>
    <span class="k">def</span> <span class="nf">read_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read results at &lt;root/?/&gt; and parse to dict of xr.DataArray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span></div>

        <span class="c1"># raise NotImplementedError()</span>

    <span class="k">def</span> <span class="nf">write_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write results at &lt;root/?/&gt; in model ready format.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
        <span class="c1"># raise NotImplementedError()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return pyproj.CRS.from_epsg(self.get_config(&quot;global.epsg&quot;, fallback=4326))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># try to read it from mesh usingMeshModel method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">crs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns model mesh bounds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">total_bounds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns geometry of region of the model area of interest.&quot;&quot;&quot;</span>
        <span class="c1"># First tries in geoms</span>
        <span class="k">if</span> <span class="s2">&quot;region&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span>
        <span class="c1"># Else derives from mesh or branches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">ugrid</span><span class="o">.</span><span class="n">total_bounds</span>
                <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">total_bounds</span>
                <span class="n">crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="o">.</span><span class="n">crs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Finally raise error assuming model is empty</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Could not derive region from geoms, or mesh. Model may be empty.&quot;</span>
                <span class="p">)</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounds</span><span class="p">)],</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">region</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dfmmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_dfmmodel</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span>

<div class="viewcode-block" id="DFlowFMModel.init_dfmmodel">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.init_dfmmodel.html#hydromt_delft3dfm.DFlowFMModel.init_dfmmodel">[docs]</a>
    <span class="k">def</span> <span class="nf">init_dfmmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create a new MDU-Model</span>
        <span class="n">mdu_fn</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">mdu_fn</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading mdu file at </span><span class="si">{</span><span class="n">mdu_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span> <span class="o">=</span> <span class="n">FMModel</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">mdu_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># use hydrolib template</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising empty mdu file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span> <span class="o">=</span> <span class="n">FMModel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfmmodel</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">mdu_fn</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DIMR file object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_dimr</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span>

<div class="viewcode-block" id="DFlowFMModel.read_dimr">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.read_dimr.html#hydromt_delft3dfm.DFlowFMModel.read_dimr">[docs]</a>
    <span class="k">def</span> <span class="nf">read_dimr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimr_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read DIMR from file and else create from hydrolib-core.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dimr_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dimr_fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr_fn</span><span class="p">)</span>
        <span class="c1"># if file exist, read</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">dimr_fn</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading dimr file at </span><span class="si">{</span><span class="n">dimr_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dimr</span> <span class="o">=</span> <span class="n">DIMR</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">dimr_fn</span><span class="p">))</span>
        <span class="c1"># else initialise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_assert_write_mode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialising empty dimr file&quot;</span><span class="p">)</span>
            <span class="n">dimr</span> <span class="o">=</span> <span class="n">DIMR</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span> <span class="o">=</span> <span class="n">dimr</span></div>


<div class="viewcode-block" id="DFlowFMModel.write_dimr">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.write_dimr.html#hydromt_delft3dfm.DFlowFMModel.write_dimr">[docs]</a>
    <span class="k">def</span> <span class="nf">write_dimr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimr_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the dmir file. In write mode, updates first the FMModel component.&quot;&quot;&quot;</span>
        <span class="c1"># force read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimr</span>
        <span class="k">if</span> <span class="n">dimr_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">dimr_fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr_fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="c1"># Updates the dimr file first before writing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding dflowfm component to dimr config&quot;</span><span class="p">)</span>

            <span class="c1"># update component</span>
            <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">component</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fmcomponent</span> <span class="o">=</span> <span class="n">FMComponent</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dflowfm&quot;</span><span class="p">,</span>
                <span class="n">workingdir</span><span class="o">=</span><span class="s2">&quot;dflowfm&quot;</span><span class="p">,</span>
                <span class="n">inputfile</span><span class="o">=</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_fn</span><span class="p">),</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dfmmodel</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmcomponent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">component</span> <span class="o">=</span> <span class="n">components</span>
            <span class="c1"># update control</span>
            <span class="n">controls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">control</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">controls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">Start</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;dflowfm&quot;</span><span class="p">)</span>
            <span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span>

        <span class="c1"># write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing model dimr file to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dimr</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimr</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">branches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the branches (gpd.GeoDataFrame object) representing the 1D network.</span>
<span class="sd">        Contains several &quot;branchtype&quot; for : channel, river, pipe, tunnel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_mesh</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span>

<div class="viewcode-block" id="DFlowFMModel.set_branches">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.set_branches.html#hydromt_delft3dfm.DFlowFMModel.set_branches">[docs]</a>
    <span class="k">def</span> <span class="nf">set_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the branches object as well as the linked geoms.&quot;&quot;&quot;</span>
        <span class="c1"># Check if &quot;branchtype&quot; col in new branches</span>
        <span class="k">if</span> <span class="s2">&quot;branchtype&quot;</span> <span class="ow">in</span> <span class="n">branches</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_branches</span> <span class="o">=</span> <span class="n">branches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;&#39;branchtype&#39; column absent from the new branches, could not update.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Update channels/pipes in geoms</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;river&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pipe&quot;</span><span class="p">)</span>

        <span class="c1"># update geom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding branches vector to geoms.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="s2">&quot;branches&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating branches in network.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">set_branches_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">gdf_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;branchtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">gdf_comp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span><span class="n">gdf_comp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf_comp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;rivers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;rivers&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="s2">&quot;river&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;channels&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;pipes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="s2">&quot;pipes&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_branches_component</span><span class="p">(</span><span class="s2">&quot;pipe&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">opensystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;branchtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;river&quot;</span><span class="p">,</span> <span class="s2">&quot;channel&quot;</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closedsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;branchtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;pipe&quot;</span><span class="p">,</span> <span class="s2">&quot;tunnel&quot;</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gdf</span>

<div class="viewcode-block" id="DFlowFMModel.get_model_time">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.get_model_time.html#hydromt_delft3dfm.DFlowFMModel.get_model_time">[docs]</a>
    <span class="k">def</span> <span class="nf">get_model_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return (refdate, tstart, tstop) tuple with parsed model reference datem start and end time.&quot;&quot;&quot;</span>
        <span class="n">refdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;time.refdate&quot;</span><span class="p">)),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">refdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;time.tstart&quot;</span><span class="p">)))</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="n">refdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;time.tstop&quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">refdate</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Resolution of the mesh2d.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_res</span>

<div class="viewcode-block" id="DFlowFMModel.set_mesh">
<a class="viewcode-back" href="../../_generated/hydromt_delft3dfm.DFlowFMModel.set_mesh.html#hydromt_delft3dfm.DFlowFMModel.set_mesh">[docs]</a>
    <span class="k">def</span> <span class="nf">set_mesh</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">xu</span><span class="o">.</span><span class="n">UgridDataArray</span><span class="p">,</span> <span class="n">xu</span><span class="o">.</span><span class="n">UgridDataset</span><span class="p">],</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite_grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data to mesh.</span>

<span class="sd">        All layers of mesh have identical spatial coordinates in Ugrid conventions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: xugrid.UgridDataArray or xugrid.UgridDataset</span>
<span class="sd">            new layer to add to mesh</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Name of new object layer, this is used to overwrite the name of</span>
<span class="sd">            a UgridDataArray.</span>
<span class="sd">        grid_name: str, optional</span>
<span class="sd">            Name of the mesh grid to add data to. If None, inferred from data.</span>
<span class="sd">            Can be used for renaming the grid.</span>
<span class="sd">        overwrite_grid: bool, optional</span>
<span class="sd">            If True, overwrite the grid with the same name as the grid in self.mesh.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if new grid_name</span>
        <span class="k">if</span> <span class="n">grid_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="n">new_grid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_grid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># First call super method to add mesh data</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_mesh</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span>
            <span class="n">overwrite_grid</span><span class="o">=</span><span class="n">overwrite_grid</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># check if 1D and 2D and and 1D2D links and overwrite then send warning that setup_link1d2d should be run again</span>
        <span class="k">if</span> <span class="n">overwrite_grid</span> <span class="ow">and</span> <span class="s2">&quot;link1d2d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid_name</span> <span class="o">==</span> <span class="s2">&quot;mesh1d&quot;</span> <span class="ow">or</span> <span class="n">grid_name</span> <span class="o">==</span> <span class="s2">&quot;mesh2d&quot;</span><span class="p">:</span>
                <span class="c1"># TODO check if warning is enough or if we should remove to be sure?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2"> grid was updated in self.mesh. &quot;</span>
                    <span class="s2">&quot;Re-run setup_link1d2d method to update the model 1D2D links.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># update related geoms if necessary: region - boundaries</span>
        <span class="c1"># the region is done in hydromt core</span>
        <span class="k">if</span> <span class="n">overwrite_grid</span> <span class="ow">or</span> <span class="n">new_grid</span><span class="p">:</span>
            <span class="c1"># 1D boundaries</span>
            <span class="k">if</span> <span class="n">grid_name</span> <span class="o">==</span> <span class="s2">&quot;mesh1d&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_geoms</span><span class="p">(</span>
                    <span class="n">workflows</span><span class="o">.</span><span class="n">get_boundaries_with_nodeid</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">,</span>
                        <span class="n">mesh_utils</span><span class="o">.</span><span class="n">network1d_nodes_geodataframe</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mesh_datasets</span><span class="p">[</span><span class="s2">&quot;network1d&quot;</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;boundaries&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">set_link1d2d</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">link1d2d</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add or replace the link1d2d in the model mesh.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        link1d2d: xr.Dataset</span>
<span class="sd">            link1d2d dataset with variables: [link1d2d, link1d2d_ids, link1d2d_long_names, link1d2d_contact_type]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if link1d2d already in self.mesh</span>
        <span class="c1"># FIXME current implementation of below does not support updating partial 1d2d links. Either document or adapt. #1</span>
        <span class="k">if</span> <span class="s2">&quot;link1d2d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overwriting existing link1d2d in self.mesh.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;link1d2d&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;link1d2d_ids&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;link1d2d_long_names&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;link1d2d_contact_type&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Remove unused dims nLink1D2D_edge and Two</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">([</span><span class="s2">&quot;nLink1D2D_edge&quot;</span><span class="p">,</span> <span class="s2">&quot;Two&quot;</span><span class="p">])</span>

        <span class="c1"># Add link1d2d to mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mesh</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">link1d2d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_model_has_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;mesh2d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_model_has_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;mesh1d&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_check_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not derive CRS from reading the mesh file.&quot;</span>
                    <span class="s2">&quot;Please define the CRS in the [global] init attributes before setting up the model.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;CRS is not defined. Please define the CRS in the [global] init attributes before setting up the model.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;project crs: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright Deltares.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>